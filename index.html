<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tam√°s Mesters√©ges (AI)</title>
  <link rel="icon" href="data:," />

  <style>
    :root{
      --bg: #0f1115;
      --panel: rgba(24,26,32,.75);
      --panel-blur: blur(12px);
      --accent: #f39c12;
      --accent-2: #3aa9ff;
      --text: #e8e8ea;
      --muted: #a8adb7;
      --bubble-user: linear-gradient(135deg,#ffb347,#ffcc33);
      --bubble-bot:  linear-gradient(135deg,#2c3e50,#4b79a1);
      --glass: rgba(255,255,255,.06);
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 500px at 20% -10%, #232838 0%, transparent 60%),
        radial-gradient(1000px 500px at 120% 10%, #1b2230 0%, transparent 60%),
        var(--bg);
      display:flex;
      flex-direction:column;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: saturate(140%) blur(8px);
      background: rgba(10,12,16,.55);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .bar{
      max-width:1150px; margin:auto; padding:14px 18px;
      display:flex; align-items:center; gap:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%; background:var(--accent)}
    .title{
      font-weight:800; letter-spacing:.2px; font-size:18px;
    }
    .subtitle{color:var(--muted); font-size:13px}

    /* Main layout */
    .wrap{
      max-width:1150px; margin:24px auto 18px auto;
      padding:0 18px; width:100%;
      display:grid; grid-template-columns: 1fr; gap:18px;
    }

    /* Card */
    .card{
      border-radius:var(--radius);
      background:var(--panel);
      backdrop-filter:var(--panel-blur);
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.08);
    }

    /* Chat container (bigger + inner scroll) */
    #chat{
      display:flex; flex-direction:column;
      height:min(78vh, 760px);
      min-height:520px;
    }
    #chatHeader{
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.07);
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    #chatBody{
      padding:16px; overflow-y:auto; flex:1;
      scroll-behavior:smooth;
    }
    #chatFooter{
      padding:12px; border-top:1px solid rgba(255,255,255,.07);
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }

    /* Bubbles */
    .msg{max-width:80%; padding:10px 14px; border-radius:16px; margin:8px 0; color:#fff}
    .user{margin-left:auto; background:var(--bubble-user); color:#231e0d}
    .bot{margin-right:auto; background:var(--bubble-bot)}
    .info{
      margin: 8px auto; max-width:85%;
      background:var(--glass); color:var(--muted); border:1px dashed rgba(255,255,255,.1)
    }

    /* Controls */
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1);
      color:var(--text);
      padding:10px 12px; border-radius:999px;
      display:flex; align-items:center; gap:8px;
    }
    .pill input{all:unset}
    .btn{
      cursor:pointer; user-select:none;
      background:var(--accent); color:#1c1300;
      padding:10px 14px; border-radius:12px; border:none; font-weight:700;
      box-shadow: 0 6px 18px rgba(243,156,18,.35);
    }
    .btn.secondary{
      background:#2f3849; color:#e2e7f0; box-shadow:none; border:1px solid rgba(255,255,255,.08)
    }
    .field{
      flex:1; display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px; padding:8px 10px;
    }
    #text{all:unset; color:var(--text); width:100%}
    .hint{color:var(--muted); font-size:12px}

    /* Footer legal */
    footer{
      color:#b4b8c2; font-size:12px; text-align:center;
      padding:16px 12px; opacity:.85;
    }

    /* Mobile tweaks */
    @media (max-width:720px){
      #chat{height: 75vh; min-height:480px}
      .msg{max-width: 92%}
    }
  </style>
</head>
<body>

  <!-- Fejl√©c -->
  <header>
    <div class="bar">
      <div class="dot" aria-hidden="true"></div>
      <div class="title">Tam√°s Mesters√©ges (AI)</div>
      <div class="subtitle">Magyar nyelv≈±, bar√°ts√°gos asszisztens</div>
    </div>
  </header>

  <main class="wrap">
    <!-- CHAT -->
    <section id="chat" class="card" aria-label="Besz√©lget√©s">
      <div id="chatHeader">
        <div style="font-weight:700">Besz√©lget√©s</div>
        <div class="pill">
          <label><input type="checkbox" id="ttsToggle" checked /> Hang (felolvas√°s)</label>
          <span style="opacity:.35">‚Ä¢</span>
          <button id="micBtn" class="btn secondary" type="button">üé§ Mikrofon ind√≠t√°sa</button>
        </div>
      </div>

      <div id="chatBody" aria-live="polite"></div>

      <div id="chatFooter">
        <div class="field">
          <input id="text" placeholder="√çrj ide‚Ä¶  (Enter = k√ºld√©s, Shift+Enter = √∫j sor)" />
        </div>
        <button id="sendBtn" class="btn" type="button">K√ºld√©s</button>
        <div class="hint">Tipp: k√©rdezd meg pl. ‚ÄûMilyen nap lesz holnap?‚Äù</div>
      </div>
    </section>
  </main>

  <footer>
    V√©dett oldal ‚Äì b√°rmilyen enged√©ly n√©lk√ºli m√°sol√°s <strong>jogs√©rt√©s</strong>. ¬© Tam√°s AI
  </footer>

  <script>
    // ====== √Ållapot ======
    const chatBody = document.querySelector('#chatBody');
    const input = document.querySelector('#text');
    const sendBtn = document.querySelector('#sendBtn');
    const ttsToggle = document.querySelector('#ttsToggle');
    const micBtn = document.querySelector('#micBtn');

    let recognizing = false;
    let voiceOnly = false;   // ha igaz, a hangos m√≥d NEM √≠r a chatbe
    let rec;                 // SpeechRecognition
    let lastBot = '';        // utols√≥ bot v√°lasz (m√°sol√°shoz / felolvas√°shoz)

    // ====== Seg√©dek ======
    function addMsg(text, who='bot', cls=''){
      const div = document.createElement('div');
      div.className = `msg ${who} ${cls}`.trim();
      div.textContent = text;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
      return div;
    }
    function addInfo(text){
      return addMsg(text, '', 'info');
    }

    function speakHu(text){
      if(!ttsToggle.checked) return;
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'hu-HU';
        u.rate = 1; u.pitch = 1;
        speechSynthesis.cancel(); // el≈ëz≈ë megszak√≠t√°sa
        speechSynthesis.speak(u);
      }catch(_){}
    }

    // D√°tumok ‚Äì mai nap √©s k√∂vetkez≈ë 7 nap neve + d√°tuma
    function dateHints(){
      const now = new Date();
      const days = ['vas√°rnap','h√©tf≈ë','kedd','szerda','cs√ºt√∂rt√∂k','p√©ntek','szombat'];
      const pad = n => String(n).padStart(2,'0');
      const today = `Ma ${now.getFullYear()}. ${pad(now.getMonth()+1)}. ${pad(now.getDate())}. (${days[now.getDay()]})`;
      const next = Array.from({length:7}, (_,i)=>{
        const d = new Date(now); d.setDate(d.getDate()+i+1);
        return `${days[d.getDay()]} ‚Äì ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}.`;
      }).join('  ‚Ä¢  ');
      return {today, next};
    }

    // ====== Kezd≈ë √ºdv√∂zl√©s ======
    (function greet(){
      const {today, next} = dateHints();
      addMsg('Szia! √ñr√ºl√∂k, hogy itt vagy! K√©rdezz b√°tran; seg√≠tek. üôÇ','bot');
      addInfo(`${today}`);
      addInfo(`K√∂vetkez≈ë napok: ${next}`);
    })();

    // ====== K√ºld√©s (g√©pel≈ës m√≥d) ======
    sendBtn.addEventListener('click', ()=> sendText());
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }
    });

    async function sendText(text){
      const msg = (text ?? input.value ?? '').trim();
      if(!msg) return;
      input.value='';

      addMsg(msg,'user');
      await askBackend(msg, {suppressChat:false});
    }

    // ====== Hangos m√≥d (nem √≠r a chatbe) ======
    micBtn.addEventListener('click', async ()=>{
      if(recognizing){ stopRec(); return; }
      startRec();
    });

    function startRec(){
      if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
        addInfo('A hangfelismer√©s nem t√°mogatott ezen az eszk√∂z√∂n / b√∂ng√©sz≈ëben.');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      rec = new SR();
      rec.lang = 'hu-HU';
      rec.continuous = true;
      rec.interimResults = true;

      voiceOnly = true;     // fontos: ne √≠rjunk a chatbe hang m√≥dban
      recognizing = true;
      micBtn.textContent = 'üîá Le√°ll√≠t√°s';

      let buffer = '';
      rec.onresult = async (ev)=>{
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          const r = ev.results[i];
          if(r.isFinal){
            const said = r[0].transcript.trim();
            buffer = '';
            if(said){
              // NEM √≠runk felhaszn√°l√≥i bubor√©kot; k√∂zvetlen√ºl k√©rdez√ºnk:
              await askBackend(said, {suppressChat:true});
            }
          }else{
            // k√∂ztes eredm√©ny: csak gy≈±jtj√ºk, de nem jelen√≠tj√ºk meg
            buffer = r[0].transcript;
          }
        }
      };
      rec.onerror = e=>{
        addInfo('Felismer√©si hiba: '+ (e.error||'ismeretlen'));
      };
      rec.onend = ()=>{
        recognizing=false; voiceOnly=false;
        micBtn.textContent = 'üé§ Mikrofon ind√≠t√°sa';
      };
      try{ rec.start(); }catch(_){}
    }
    function stopRec(){ try{ rec && rec.stop(); }catch(_){} }

    // ====== Backend h√≠v√°s ======
    async function askBackend(userText, opts={suppressChat:false}){
      // K√ºl√∂n "gondolkodom" jelz√©s
      const thinking = !opts.suppressChat ? addInfo('‚Ä¶') : null;

      try{
        const r = await fetch('/.netlify/functions/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: userText })
        });
        if(!r.ok) throw new Error('HTTP '+r.status);

        const data = await r.json();
        const reply = String(data.reply ?? '√ârtem. Miben seg√≠thetek m√©g?');

        lastBot = reply;

        // Ha voiceOnly (hang m√≥d) vagy suppressChat, nem √≠runk bubor√©kot,
        // csak felolvassuk a v√°laszt:
        if(opts.suppressChat || voiceOnly){
          if(thinking) thinking.remove();
          speakHu(reply);
          return;
        }

        if(thinking) thinking.remove();
        addMsg(reply,'bot');
        if(ttsToggle.checked) speakHu(reply);

      }catch(e){
        if(thinking) thinking.remove();
        addMsg('Hiba: '+(e.message||e),'bot','info');
      }
    }
  </script>
</body>
</html>

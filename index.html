<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no" />
  <title>Tam√°s Mesters√©ges (AIPro)</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --panel:#0f1620cc; --text:#e8eef6; --muted:#9fb0c3;
      --bubbleUser:#ffb84d; --bubbleBot:#243447; --bubbleInfo:#1b2838;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --danger:#ff4d4d;
    }
    html,body{height:100%;overflow:hidden}
    body{
      margin:0; color:var(--text);
      font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      position:relative; height:100dvh; touch-action:manipulation; -webkit-text-size-adjust:100%;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background: radial-gradient(rgba(0,0,0,.58), rgba(0,0,0,.58)),
                  url("/bg_tamas.jpg") center 30% / cover no-repeat;
    }
    header{ text-align:center; margin:8px 0 6px; }
    header .ttl{ font-weight:800; font-size:20px; letter-spacing:.3px; }
    header .sub{ color:var(--muted); font-size:12px; margin-top:2px; }

    .card{
      width:min(1000px,94vw); height:78dvh;
      background:var(--panel); border:1px solid rgba(255,255,255,.08);
      border-radius:22px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; overflow:hidden; position:relative;
    }
    .errorbar{
      position:absolute; inset:0 0 auto 0;
      background:rgba(255,77,77,.12); color:#ffdede;
      padding:8px 12px; font-size:13px; display:none;
      border-bottom:1px solid rgba(255,255,255,.3);
    }
    .chatlog{ flex:1; overflow-y:auto; padding:14px; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; scroll-behavior:smooth; }

    .row{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    .row.bot{align-items:flex-start}
    .row.user{align-items:flex-end}
    .row.info{align-items:center}

    .bubble{
      max-width:min(640px,92%); padding:14px 16px; border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      word-wrap:break-word; white-space:pre-wrap;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .bot .bubble{background:var(--bubbleBot)}
    .user .bubble{background:var(--bubbleUser); color:#1f1200}
    .info .bubble{background:var(--bubbleInfo); color:var(--muted)}
    .chatlog img{ max-width:55%; border-radius:12px; display:block; margin:8px auto; }

    .tts-btn{ border:0; background:none; cursor:pointer; font-size:18px; margin:4px 0 0 6px; color:#9fb0c3; }

    .composer{ display:flex; align-items:center; gap:10px; padding:10px; background:rgba(0,0,0,.5); flex-wrap:nowrap; position:sticky; bottom:0; }
    .input{ flex:1 1 auto; display:flex; align-items:center; gap:10px; padding:10px 14px; background:#0f1620bf; border:1px solid rgba(255,255,255,.12); border-radius:14px; min-width:0; }
    .input input{ flex:1 1 auto; border:0; outline:none; background:transparent; color:var(--text); font-size:16px; min-width:0; }

    .icon-btn, label.icon-btn{
      min-width:40px; height:40px; border:0; border-radius:10px; background:#11182780; color:#fff; cursor:pointer;
      display:inline-grid; place-items:center; padding:0 10px;
    }
    .send{ flex:0 0 auto; border:0; cursor:pointer; font-weight:800; color:#331d00; background:linear-gradient(90deg,#ffb84d,#ffa53a); padding:10px 16px; border-radius:14px; white-space:nowrap; }

    footer{ margin-top:8px; font-size:12px; color:#9fb0c3; text-align:center; user-select:none; pointer-events:none }

    /* Forr√°s log√≥ cs√≠k */
    .source-badge { font-size:12px; color:#9fb0c3; }
    .source-logo {
      width:24px; height:24px; border-radius:6px; background:#0b1220;
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow:0 1px 3px rgba(0,0,0,.08); color:#e8eef6; font-weight:700; font-size:12px;
      border:1px solid rgba(255,255,255,.06);
    }
    .source-logo img { width:18px; height:18px; display:block; }
  </style>
</head>
<body>
  <header>
    <div class="ttl">Tam√°s Mesters√©ges (AI)</div>
    <div class="sub">Halad√≥ fejleszt√©s ‚Äî bar√°ts√°gos magyar asszisztens</div>
  </header>

  <section class="card">
    <div id="err" class="errorbar"></div>

    <div id="log" class="chatlog">
      <div class="row bot info">
        <div class="bubble">Szia! Itt vagyok neked, seg√≠tek mindenben. √çrj b√°tran! üòä</div>
      </div>
    </div>

    <div class="composer">
      <div class="input">
        <input id="txt" autocomplete="off"
               placeholder="√çrj ide‚Ä¶   Enter = k√ºld√©s, Shift+Enter = √∫j sor"
               onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendNow();}" />
        <input id="imgInput" type="file" accept="image/*" style="display:none" onchange="handleImage(this)" />
        <label for="imgInput" class="icon-btn" title="K√©p felt√∂lt√©s">üì∑</label>
      </div>
      <button class="send" id="sendBtn" type="button" onclick="sendNow()">K√ºld√©s</button>
    </div>
  </section>

  <footer>¬© Tam√°s AI ‚Äî v√©dett oldal. B√°rmilyen m√°sol√°s jogs√©rt√©snek min≈ës√ºl.</footer>

  <script>
    const log = document.getElementById('log');
    const txt = document.getElementById('txt');
    const errBar = document.getElementById('err');
    let context = {};
    let SENDING = false;

    function showError(msg){
      console.error(msg);
      if(!errBar) return;
      errBar.textContent = typeof msg === 'string' ? msg : (msg?.message || 'Ismeretlen hiba');
      errBar.style.display = 'block';
      setTimeout(()=> errBar.style.display='none', 4000);
    }

    function speakHu(text){
      try{
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'hu-HU'; u.rate = 1; u.pitch = 1;
        const trySpeak = () => {
          if (speechSynthesis.speaking) { setTimeout(trySpeak, 120); return; }
          speechSynthesis.speak(u);
        };
        trySpeak();
      }catch(e){}
    }

    function addRow(kind, html){
      const r=document.createElement('div'); r.className='row '+kind;
      const b=document.createElement('div'); b.className='bubble';
      b.innerHTML=html; r.appendChild(b); log.appendChild(r);
      if(kind === 'bot'){
        const tts = document.createElement('button');
        tts.className = 'tts-btn'; tts.textContent = 'üîä'; tts.title = 'Felolvas√°s';
        tts.addEventListener('click', ()=> speakHu(b.textContent)); r.appendChild(tts);
      }
      log.scrollTop=log.scrollHeight;
      return r;
    }

    // --- Forr√°s log√≥cs√≠k + fallback ---
    function domainFromUrl(u){ try { return new URL(u).hostname.replace(/^www\./,''); } catch { return ""; } }
    function gFavicon(d){ return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(d)}&sz=64`; }
    function ddgFavicon(d){ return `https://icons.duckduckgo.com/ip3/${encodeURIComponent(d)}.ico`; }

    // ut√≥lagos biztos√≠t√°s: ha nincs IMG √©s √ºres a span, √≠rjuk be az els≈ë bet≈±t
    function ensureSourceBadgesLetters(container){
      const nodes = container.querySelectorAll('.source-logo');
      nodes.forEach(sp=>{
        const hasImg = !!sp.querySelector('img');
        if (!hasImg && !sp.textContent.trim()){
          const title = sp.getAttribute('title') || '?';
          sp.textContent = (title[0]||'?').toUpperCase();
        }
      });
    }

    function renderSources(refs){
      try{
        if(!Array.isArray(refs) || !refs.length) return "";
        const seen = new Set();
        const parts = [];
        for (const s of refs){
          const link = s.link || s.url || "";
          const dom = domainFromUrl(link);
          if(!dom || seen.has(dom)) continue;
          seen.add(dom);
          const img1 = gFavicon(dom);
          const img2 = ddgFavicon(dom);
          const html = `
            <span class="source-logo" title="${dom}" aria-label="${dom}">
              <img src="${img1}" alt="${dom}"
                   onerror="this.onerror=null; this.src='${img2}';
                            this.parentElement && (this.parentElement.style.background='#0b1220');
                            this.addEventListener('error', ()=>{ const sp=this.parentElement; this.remove(); if(sp){ sp.textContent='${(dom[0]||'?').toUpperCase()}'; } });">
            </span>`;
          parts.push(html);
          if (parts.length >= 8) break;
        }
        if (!parts.length) return "";
        // becsomagolva √∫gy, hogy ut√≥lagos ellen≈ërz√©st futtassunk r√°
        const blockId = 'src_' + Math.random().toString(36).slice(2,8);
        setTimeout(()=>{
          const el = document.getElementById(blockId);
          if (el) ensureSourceBadgesLetters(el);
        }, 1200);
        return `
          <div id="${blockId}" style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="source-badge">Forr√°sok:</span> ${parts.join("")}
          </div>`;
      }catch{ return ""; }
    }

    function pickAnswer(d){
      const candidates = [d?.answer, d?.reply, d?.content, d?.message];
      for(const c of candidates){ if(typeof c === 'string' && c.trim()) return c.trim(); }
      return "";
    }
    function pickSourcesBlock(d){
      const arrays = [d?.references, d?.sources, d?.results, d?.items];
      for(const arr of arrays){ if(Array.isArray(arr) && arr.length){ return renderSources(arr); } }
      return "";
    }

    async function callServer(message, imageBase64){
      const resp = await fetch('/.netlify/functions/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message, image: imageBase64 || null, context })
      });
      if(!resp.ok){ const t = await resp.text().catch(()=> ''); throw new Error('HTTP '+resp.status+' ‚Äî '+t); }
      return resp.json();
    }

    async function sendNow(){
      try{
        if (SENDING) return;
        const message = (txt?.value || '').trim();
        if(!message){ txt.placeholder = "√çrj valamit el≈ëbb üôÇ"; txt?.focus(); return; }

        SENDING = true;
        const userMsg = message;
        txt.value=''; txt.dispatchEvent(new Event('input'));

        addRow('user', userMsg);
        const thinking = addRow('bot','<i>Gondolkodj a v√°lasz√©rt‚Ä¶</i>');

        const data = await callServer(userMsg, null);
        thinking.remove();
        if (data && data.meta) context = data.meta;

        let answer = pickAnswer(data) || "Sajn√°lom, most nem tal√°ltam el√©g inform√°ci√≥t. Pr√≥b√°ljuk pontosabban megfogalmazni?";
        let sourcesHtml = pickSourcesBlock(data);
        const row = addRow('bot', answer + sourcesHtml);
        // extra bet≈±-biztos√≠t√°s
        ensureSourceBadgesLetters(row);
      }catch(e){
        showError(e);
        addRow('bot','Hiba t√∂rt√©nt. (Lehet, hogy a Netlify-f√ºggv√©ny nem √©rhet≈ë el.)');
      } finally {
        SENDING = false;
      }
    }
    window.sendNow = sendNow;

    // K√©pkezel√©s (ha haszn√°lod)
    async function compressToDataURL(file, maxWidth = 1600, targetKB = 350, minQuality = 0.6){
      const mime = (file.type || '').toLowerCase();
      if (mime.includes('heic') || mime.includes('heif')) throw new Error('A kep HEIC/HEIF formatumu. Mentsd JPG-k√©nt, majd pr√≥b√°ld √∫jra üì∑');
      const dataURL = await new Promise((res, rej) => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); });
      const img = await new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = () => rej(new Error('Nem sikerult betolteni a kepet')); i.src = dataURL; });
      let q=0.85, w=Math.min(maxWidth,img.width), h=Math.round(img.height*(w/img.width));
      const canvas=document.createElement('canvas'), ctx=canvas.getContext('2d');
      function exportJpeg(){ canvas.width=w; canvas.height=h; ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h); return canvas.toDataURL('image/jpeg',q); }
      let out=exportJpeg(), bytes=Math.ceil((out.length*3)/4), targetBytes=targetKB*1024, steps=0;
      while(bytes>targetBytes && steps<6){ if(q>minQuality) q=Math.max(minQuality,q-0.1); else if(w>720){ w=Math.round(w*0.8); h=Math.round(h*0.8);} else break; out=exportJpeg(); bytes=Math.ceil((out.length*3)/4); steps++; }
      return out;
    }
    async function processImageFile(file){
      try{
        const b64 = await compressToDataURL(file, 1600, 350, 0.6);
        addRow('user', `<img src="${b64}" alt="Felt√∂lt√∂tt k√©p">`);
        const thinking = addRow('bot','<i>Gondolkodj a v√°lasz√©rt‚Ä¶</i>');
        const data = await callServer('', b64);
        thinking.remove();
        if (data && data.meta) context = data.meta;
        let answer = pickAnswer(data) || 'Sz√©p k√©p! üôÇ';
        let sourcesHtml = pickSourcesBlock(data);
        const row = addRow('bot', answer + sourcesHtml);
        ensureSourceBadgesLetters(row);
      }catch(e){
        showError(e);
        addRow('bot','Nem siker√ºlt feldolgozni a k√©pet. Lehet t√∫l nagy a f√°jl? üì∑');
      }
    }
    async function handleImage(inputEl){ const file = inputEl?.files && inputEl.files[0]; if(!file) return; await processImageFile(file); if(inputEl) inputEl.value=''; }
    window.handleImage = handleImage;

    // paste & dragdrop
    window.addEventListener('paste', async (e)=>{ const items = e.clipboardData?.items || []; for (const it of items){ if (it.type && it.type.startsWith('image/')){ const file = it.getAsFile(); if (file) { await processImageFile(file); e.preventDefault(); break; } } } });
    log.addEventListener('dragover', e => { e.preventDefault(); });
    log.addEventListener('drop', async e => { e.preventDefault(); const files = e.dataTransfer?.files || []; for (const f of files){ if (f.type && f.type.startsWith('image/')){ await processImageFile(f); break; } } });

    // --- Glob√°lis hibafigyel≈ë: resource load hib√°k elnyelve
    window.addEventListener('error', (e) => {
      const t = e.target;
      if (t && (t.tagName === 'IMG' || t.tagName === 'LINK' || t.tagName === 'SCRIPT')) return;
      const msg = e?.message || 'Ismeretlen hiba';
      showError(msg);
    }, true);
  </script>
</body>
</html>

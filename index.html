<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HT Chat ‚Äì Kellemes besz√©lget√©st!</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <style>
    :root{
      --bg:#0f1116; --panel:#171a22; --panel2:#1f2430;
      --text:#eaeef7; --muted:#a9b3c7; --brand:#ff8a2a; --ok:#2ecc71; --err:#ff5e57;
      --bubble:#222736; --bubble-me:#ff8a2a22; --ring:#ff8a2a55;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background: radial-gradient(1200px 800px at 20% -20%, #ff8a2a18, transparent 60%),
                  radial-gradient(800px 800px at 120% 0%, #5a9cff18, transparent 60%),
                  var(--bg);
      color:var(--text); display:flex; flex-direction:column; gap:8px;
    }
    header{padding:18px 16px 0; text-align:center}
    h1{margin:0; font-weight:800; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:.95rem; margin-top:6px}

    .tabs{display:flex; gap:8px; justify-content:center; margin:14px 0 6px}
    .tab{padding:10px 14px; border-radius:999px; background:var(--panel); color:var(--muted);
         cursor:pointer; border:1px solid #ffffff12}
    .tab.active{background:var(--panel2); color:var(--text); box-shadow:0 0 0 3px #ffffff08 inset}
    main{flex:1; display:grid; place-items:center; padding:10px}
    .container{width:min(1024px, 100%); display:grid; grid-template-columns:1fr; gap:14px}

    /* Chat panel */
    .card{background:var(--panel2); border:1px solid #ffffff10; border-radius:18px; padding:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .toggle{display:flex; align-items:center; gap:8px; font-size:.92rem; color:var(--muted)}
    input[type="checkbox"]{width:18px; height:18px; accent-color:var(--brand)}
    .chat{
      height:52vh; min-height:360px; overflow:auto; padding:12px; background:var(--panel);
      border:1px solid #ffffff10; border-radius:14px; scroll-behavior:smooth;
    }
    .b{max-width:82%; padding:10px 12px; margin:6px 0; border-radius:12px;
       background:var(--bubble); box-shadow:0 1px 0 #0004}
    .me{margin-left:auto; background:var(--bubble-me); border:1px solid var(--ring)}
    .info{background:#1b2030; color:#cfe3ff}
    .err{background:#2b1516; color:#ffc9c9; border:1px solid #ff6b6b44}
    .inputRow{display:flex; gap:8px; margin-top:10px}
    textarea{
      flex:1; background:transparent; color:var(--text); border:1px solid #ffffff1a; border-radius:12px;
      resize:none; height:48px; padding:12px 12px; outline:none;
    }
    button{
      background:var(--brand); color:#1b120a; border:none; padding:0 16px; border-radius:12px;
      font-weight:700; cursor:pointer; height:48px;
    }

    /* Voice panel */
    .voiceHint{color:var(--muted); font-size:.95rem; margin-bottom:10px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px;
          background:var(--panel); border:1px solid #ffffff12}
    .mic{
      width:74px; height:74px; border-radius:50%; border:none; cursor:pointer;
      background: radial-gradient(120% 120% at 30% 20%, #ffb37c, #ff8a2a 60%);
      box-shadow:0 8px 24px #ff8a2a55, inset 0 0 0 4px #ffffff22;
      color:#281709; font-size:26px; font-weight:700;
    }
    .mic.stop{background: radial-gradient(120% 120% at 30% 20%, #ff7c7c, #ff2a2a 60%);
              box-shadow:0 8px 24px #ff2a2a55, inset 0 0 0 4px #ffffff22;}
    .voiceUI{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .status{font-size:.9rem; color:var(--muted)}
    footer{padding:16px; text-align:center; color:var(--muted); font-size:.9rem}
    @media (max-width:600px){
      .chat{height:56vh}
      .mic{width:68px; height:68px}
    }
  </style>
</head>
<body>
  <header>
    <h1>HT Chat ‚Äî Kellemes besz√©lget√©st! üß°</h1>
    <div class="sub">Az oldalt l√©trehozta <b>H.T</b> ‚Äî egyedi fejleszt√©ssel.</div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="chat">Chat</div>
    <div class="tab" data-tab="voice">Hangos m√≥d</div>
  </div>

  <main>
    <div class="container">
      <!-- CHAT -->
      <section id="chat" class="card">
        <div class="row">
          <label class="toggle"><input id="copyToggle" type="checkbox" /> M√°sol√°s (utols√≥ v√°lasz)</label>
          <label class="toggle"><input id="speakToggle" type="checkbox" /> Hang (felolvas√°s)</label>
          <div class="toggle">Tipp: Enter = k√ºld√©s, Shift+Enter = √∫j sor</div>
        </div>

        <div id="chatBox" class="chat"></div>

        <div class="inputRow">
          <textarea id="msg" placeholder="√çrj ide‚Ä¶"></textarea>
          <button id="send">K√ºld√©s</button>
        </div>
      </section>

      <!-- VOICE -->
      <section id="voice" class="card" style="display:none">
        <div class="voiceHint">
          Koppints a jobb oldali gombra. Egyszer elind√≠tod ‚Üí <b>folyamatosan hallgat √©s v√°laszol</b>, am√≠g le nem √°ll√≠tod.
          iPhone-on a b√∂ng√©sz≈ëk t√∂bbs√©ge <b>nem t√°mogatja</b> a webes besz√©dfelismer√©st ‚Äì ott k√ºl√∂n Realtime megold√°s kell.
        </div>

        <div class="voiceUI">
          <div class="pill">
            <span>√Ållapot:</span>
            <b id="vState">inakt√≠v</b>
          </div>

          <button id="micBtn" class="mic" title="Start/Stop">üé§</button>
        </div>
      </section>
    </div>
  </main>

  <footer>¬© H.T ‚Äî saj√°t hobbi fejleszt√©s. J√≥ sz√≥rakoz√°st! üéâ</footer>

  <script>
    // ===== Tabs =====
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('chat').style.display  = t.dataset.tab==='chat'  ? '' : 'none';
      document.getElementById('voice').style.display = t.dataset.tab==='voice' ? '' : 'none';
    }));

    // ===== Chat UI =====
    const chatBox = document.getElementById('chatBox');
    const msg     = document.getElementById('msg');
    const send    = document.getElementById('send');
    const speakOn = document.getElementById('speakToggle');
    const copyOn  = document.getElementById('copyToggle');

    let lastBot = "";

    function addMsg(text, who='bot'){
      const div = document.createElement('div');
      div.className = 'b ' + (who==='me' ? 'me':'' );
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }
    function addInfo(t){ addMsg(t,'info'); }
    function addErr(t){ addMsg(t,'err'); }

    function speakHu(t){
      try{
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'hu-HU';
        u.rate = 1; u.pitch = 1;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(_){}
    }

    async function ask(text){
      const r = await fetch('/.netlify/functions/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: text })
      });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function onSend(){
      const t = msg.value.trim();
      if(!t) return;
      addMsg(t,'me');
      msg.value = '';
      try{
        const data = await ask(t);
        lastBot = (data.reply||'').toString();
        addMsg(lastBot,'bot');
        if(speakOn.checked) speakHu(lastBot);
        if(copyOn.checked){
          try{ await navigator.clipboard.writeText(lastBot); }catch(_){}
        }
      }catch(e){
        addErr('Hiba: ' + (e.message||e));
      }
    }

    send.addEventListener('click', onSend);
    msg.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onSend(); }
    });

    // Kezd≈ë √ºzenet
    addInfo('Szia! √çrj b√°tran, miben seg√≠thetek? üôÇ');

    // ===== Hangos m√≥d (Web Speech API ‚Äì Android/Chrome/Edge t√°mogatott) =====
    const vState = document.getElementById('vState');
    const micBtn = document.getElementById('micBtn');

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const TTSok = 'speechSynthesis' in window;
    let rec = null, listening = false, watchdog = null;

    function setVState(s){ vState.textContent = s; }
    function supportsSR(){ return !!SR; }

    function startWatchdog(){
      stopWatchdog();
      watchdog = setTimeout(()=>{
        // ha 12 mp-ig nincs esem√©ny, √∫jraind√≠tjuk a felv√©telt
        if(listening && rec){ try{ rec.stop(); }catch(_){ } }
      }, 12000);
    }
    function stopWatchdog(){ if(watchdog){ clearTimeout(watchdog); watchdog=null; } }

    function initRec(){
      if(!supportsSR()) return null;
      const r = new SR();
      r.lang = 'hu-HU';
      r.continuous = true;
      r.interimResults = false;

      r.onstart = ()=>{ setVState('hallgat‚Ä¶'); startWatchdog(); };
      r.onend   = ()=>{ stopWatchdog(); if(listening){ try{ r.start(); }catch(_){ setTimeout(()=>{ try{ r.start(); }catch(_){} }, 400); } } };
      r.onerror = (e)=>{ stopWatchdog(); addErr('Felismer√©si hiba: ' + (e.error||'ismeretlen')); };
      r.onresult = async (ev)=>{
        stopWatchdog();
        const res = ev.results[ev.results.length-1];
        const said = res[0].transcript.trim();
        if(!said) { startWatchdog(); return; }

        // nem √≠rjuk be a chatbe ‚Üí tiszta voice m√≥d
        try{
          const data = await ask(said);
          const reply = (data.reply||'').toString();
          if(TTSok){ speakHu(reply); }
        }catch(e){
          addErr('Hiba (voice): ' + (e.message||e));
        }
        startWatchdog();
      };
      return r;
    }

    function startVoice(){
      if(!supportsSR()){ addErr('A b√∂ng√©sz≈ëd nem t√°mogatja a besz√©dfelismer√©st (iPhone Safari nem t√°mogatott).'); return; }
      if(!rec) rec = initRec();
      listening = true;
      micBtn.classList.add('stop');
      setVState('hallgat‚Ä¶');
      try{ rec.start(); }catch(_){ /* ha already started, onend √∫jraind√≠tja */ }
    }
    function stopVoice(){
      listening = false;
      setVState('inakt√≠v');
      micBtn.classList.remove('stop');
      stopWatchdog();
      if(rec){ try{ rec.stop(); }catch(_){} }
      if(TTSok){ speechSynthesis.cancel(); }
    }

    micBtn.addEventListener('click', ()=> listening ? stopVoice() : startVoice());
  </script>
</body>
</html>

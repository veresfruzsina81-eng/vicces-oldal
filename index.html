<!doctype html>
<html lang="hu" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Tam√°s Mesters√©ges (AI)</title>
  <meta name="description" content="Halad√≥ fejleszt√©s ‚Äî bar√°ts√°gos magyar asszisztens." />
  <meta property="og:title" content="Tam√°s Mesters√©ges (AI)" />
  <meta property="og:description" content="Halad√≥ fejleszt√©s ‚Äî bar√°ts√°gos magyar asszisztens." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/bg_tamas.jpg" />
  <link rel="icon" href="/favicon.ico" />

  <style>
    :root{
      --bg: #0b0f14;
      --panel:#0f1620cc;
      --bubbleUser:#ffb84d;
      --bubbleBot:#243447;
      --bubbleInfo:#1b2838;
      --text:#e8eef6;
      --muted:#9fb0c3;
      --accent:#6ea8fe;
      --glow: 0 10px 30px rgba(110,168,254,.18);
      --ring: 0 0 0 2px rgba(110,168,254,.35);
    }
    [data-theme="light"]{
      --bg:#f4f7fb;
      --panel:#ffffffd9;
      --bubbleUser:#ffd089;
      --bubbleBot:#eaf0f7;
      --bubbleInfo:#dde7f3;
      --text:#0c1624;
      --muted:#52657a;
      --accent:#2b74ff;
      --glow: 0 10px 26px rgba(43,116,255,.15);
      --ring: 0 0 0 2px rgba(43,116,255,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text); background:var(--bg);
      overflow:hidden; /* oldal fix, csak a chat g√∂rget */
      background-image: radial-gradient(transparent, rgba(0,0,0,.35)), url('/bg_tamas.jpg');
      background-size: cover; background-position: 50% 30%; background-attachment: fixed;
      transition: background-color .3s ease;
    }

    .wrap{max-width:1000px; margin:0 auto; padding:18px; }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, var(--panel), transparent);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{
      display:flex; align-items:center; gap:14px; padding:10px 10px 12px;
    }
    .brand .ttl{font-weight:800; font-size:26px; letter-spacing:.3px}
    .brand .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .toolbar{margin-left:auto; display:flex; gap:10px}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:var(--panel); color:var(--text);
      padding:8px 12px; border-radius:12px; cursor:pointer;
      font-weight:600; font-size:13px;
      box-shadow: var(--glow);
    }

    .card{
      height:calc(100vh - 96px);
      background:var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px; padding:16px;
      box-shadow: var(--glow);
      display:flex; flex-direction:column;
    }

    .chat{display:flex; gap:16px; height:100%}
    .col{flex:1; min-width:0}
    .chatlog{
      height:100%;
      overflow:auto; padding:12px;
      scroll-behavior:smooth;
      border-radius:18px;
      background:linear-gradient(180deg, transparent, rgba(255,255,255,.02));
    }

    .row{display:flex; margin:10px 0}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .row.info{justify-content:flex-start}
    .bubble{
      max-width:min(640px, 92%); padding:12px 14px; border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      position:relative; word-wrap:break-word; white-space:pre-wrap;
    }
    .bot .bubble{background:var(--bubbleBot)}
    .user .bubble{background:var(--bubbleUser); color:#1f1200}
    .info .bubble{background:var(--bubbleInfo); color:var(--muted)}
    .bubble.glow{ box-shadow: var(--glow) }

    /* k√©p-el≈ën√©zet a bubor√©kban */
    .bubble img.preview{
      display:block; max-width:320px; max-height:240px; width:auto; height:auto; border-radius:12px;
    }

    .composer{display:flex; align-items:center; gap:10px; padding:12px}
    .input{
      flex:1; display:flex; align-items:center; gap:10px; padding:10px 12px;
      background:var(--panel); border:1px solid rgba(255,255,255,.12);
      border-radius:16px; box-shadow: var(--glow);
    }
    .input input{
      flex:1; background:transparent; border:0; outline:none; color:var(--text); font-size:15px;
    }
    .icon-btn{
      width:38px; height:38px; border-radius:50%; display:grid; place-items:center; cursor:pointer;
      border:1px solid rgba(255,255,255,.14); background:var(--panel); box-shadow: var(--glow);
      color:var(--text); font-size:18px;
    }
    .send{padding:10px 16px; border-radius:16px; background:linear-gradient(90deg, #ffb84d, #ffa53a);
      color:#331d00; font-weight:800; border:0; cursor:pointer}
    .send:active{transform:translateY(1px)}

    .foot{color:var(--muted); font-size:12px; text-align:center; padding:8px 4px}

    /* typing indicator */
    .typing{display:inline-flex; gap:6px; align-items:center}
    .dot{width:6px; height:6px; border-radius:50%; background:#cfe0ff; opacity:.7;
      animation:blink 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{transform:translateY(0);opacity:.35}40%{transform:translateY(-4px);opacity:1}}
  </style>
</head>

<body>
  <header>
    <div class="wrap brand">
      <div>
        <div class="ttl">Tam√°s Mesters√©ges (AI)</div>
        <div class="sub">Halad√≥ fejleszt√©s ‚Äî bar√°ts√°gos magyar asszisztens</div>
      </div>
      <div class="toolbar">
        <button class="btn" id="themeBtn" title="T√©ma v√°lt√°s">Light / Dark</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="chat">
        <div class="col">
          <div id="log" class="chatlog"></div>

          <div class="composer">
            <div class="input">
              <input id="txt" autocomplete="off" placeholder="√çrj ide‚Ä¶   Enter = k√ºld√©s, Shift+Enter = √∫j sor" />
              <!-- K√âPFELT√ñLT√âS -->
              <input type="file" id="imgUpload" accept="image/*" style="display:none" />
              <button class="icon-btn" id="imgBtn" title="K√©p felt√∂lt√©s">üì∑</button>
              <!-- /K√âPFELT√ñLT√âS -->
              <button class="icon-btn" id="ttsBtn" title="Felolvas√°s ki/be">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 10v4h4l5 5V5L7 10H3zm13.5 2a3.5 3.5 0 0 0-2.5 1.03v-2.14A5.5 5.5 0 0 1 22 12a5.5 5.5 0 0 1-8 4.93v-2.14A3.5 3.5 0 0 0 16.5 12z"/></svg>
              </button>
            </div>
            <button class="send" id="sendBtn">K√ºld√©s</button>
          </div>

          <div class="foot">¬© Tam√°s AI ‚Äî v√©dett oldal. B√°rmilyen m√°sol√°s jogs√©rt√©snek min≈ës√ºl.</div>
        </div>
      </div>
    </section>
  </main>

<script>
  // ----- T√©ma kapcsol√≥ -----
  const themeBtn = document.getElementById('themeBtn');
  themeBtn.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  });
  (()=>{
    const saved = localStorage.getItem('theme');
    if(saved) document.documentElement.setAttribute('data-theme', saved);
  })();

  // ----- Chat v√°ltoz√≥k -----
  const log = document.getElementById('log');
  const txt = document.getElementById('txt');
  const sendBtn = document.getElementById('sendBtn');
  const ttsBtn = document.getElementById('ttsBtn');
  const imgBtn = document.getElementById('imgBtn');
  const imgUpload = document.getElementById('imgUpload');

  let speakOn = false;
  ttsBtn.addEventListener('click', ()=>{ speakOn = !speakOn; ttsBtn.classList.toggle('on', speakOn); });

  function speakHu(text){
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'hu-HU'; u.rate = 1; u.pitch = 1;
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function addRow(kind, text, imgSrc){
    const r=document.createElement('div'); r.className='row '+(kind==='info'?'info':kind);
    const b=document.createElement('div'); b.className='bubble glow';
    if(imgSrc){
      const im=document.createElement('img'); im.className='preview'; im.alt='Felt√∂lt√∂tt k√©p'; im.src=imgSrc;
      b.appendChild(im);
      if(text){ const p=document.createElement('div'); p.style.marginTop='6px'; p.textContent=text; b.appendChild(p); }
    }else{
      b.textContent = text;
    }
    r.appendChild(b); log.appendChild(r); log.scrollTop = log.scrollHeight; return r;
  }

  function addTyping(){
    const r=document.createElement('div'); r.className='row bot';
    const b=document.createElement('div'); b.className='bubble glow';
    const w=document.createElement('span'); w.className='typing';
    w.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    b.appendChild(w); r.appendChild(b); log.appendChild(r); log.scrollTop=log.scrollHeight; return r;
  }

  // ---- k√©p t√∂m√∂r√≠t√©s, hogy biztos √°tmenjen ----
  async function fileToCompressedDataURL(file, maxW=1280, quality=0.85){
    const base = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    const img = new Image(); img.src = base; await new Promise(r=>img.onload=r);
    const scale = Math.min(1, maxW / img.width);
    const canvas = document.createElement('canvas');
    canvas.width = Math.round(img.width * scale); canvas.height = Math.round(img.height * scale);
    const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height);
    return canvas.toDataURL('image/jpeg', quality);
  }

  // ---- k√©p felt√∂lt√©s gomb ----
  let uploadedImageBase64 = null;
  imgBtn.addEventListener('click', ()=> imgUpload.click());
  imgUpload.addEventListener('change', async ()=>{
    const f = imgUpload.files[0]; if(!f) return;
    try{
      uploadedImageBase64 = await fileToCompressedDataURL(f);
      addRow('user', '', uploadedImageBase64); // el≈ën√©zet
      ask(); // automatikus k√ºld√©s
    }catch(e){
      addRow('bot', 'Hiba a k√©p feldolgoz√°s√°n√°l: '+(e.message||e));
    }
  });

  async function ask(){
    const text = (txt.value || '').trim();
    if(!text && !uploadedImageBase64) return;
    if(text) addRow('user', text);
    txt.value='';

    const typing = addTyping();
    try{
      const r = await fetch('/.netlify/functions/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: text, image: uploadedImageBase64 })
      });
      typing.remove();
      const data = await r.json();
      const reply = String(data.reply ?? '').trim() || "√ârtem. Miben seg√≠thetek m√©g?";
      addRow('bot', reply);
      if(speakOn) speakHu(reply);
    }catch(e){
      typing.remove();
      addRow('bot', `Hiba: ${e.message || e}`);
    }
    uploadedImageBase64 = null; // reset
  }

  sendBtn.addEventListener('click', ask);
  txt.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(); } });

  // Kezd≈ë √ºzenet ‚Äì csak egyszer
  addRow('bot', 'Szia! Itt vagyok neked, seg√≠tek mindenben. √çrj b√°tran! üòä');
</script>
</body>
</html>

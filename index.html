<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TamAI ‚Äì bar√°ts√°gos besz√©lget≈ë</title>
<style>
  :root{
    --bg:#0c1116; --panel:#111827; --muted:#9aa4b2; --text:#e5e7eb;
    --brand:#7c3aed; --brand-2:#06b6d4; --card:#0f172a; --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b0f14,#0d131b 60%,#0b1220); color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .title{font-weight:800;letter-spacing:.3px;font-size:clamp(20px,4vw,28px)}
  .owner{color:var(--muted);font-size:14px}
  .owner strong{color:#fff}
  .panel{background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.35);}
  .chat{display:grid; grid-template-columns: 1fr 320px; gap:16px; min-height:70vh}
  @media (max-width:960px){ .chat{grid-template-columns:1fr} }
  .msgs{padding:16px; overflow:auto; max-height:68vh}
  .bubble{max-width:75%;padding:12px 14px;border-radius:14px;margin:8px 0;line-height:1.45;white-space:pre-wrap}
  .me{background:linear-gradient(180deg,#0b1220,#0b1220); border:1px solid #1b2634}
  .ai{background:linear-gradient(180deg,#0f1630,#0b1630); border:1px solid #1f2d48}
  .inputbar{display:flex; gap:8px; padding:12px; border-top:1px solid var(--border); background:rgba(0,0,0,.25); border-radius:0 0 16px 16px}
  input,button,select{color:var(--text)}
  input[type=text]{flex:1; padding:12px 14px; border-radius:12px; background:#0c1420; border:1px solid #203043; outline:none}
  input[type=text]::placeholder{color:#6b7280}
  .btn{padding:12px 14px; border-radius:12px; border:1px solid #2a3750; background:linear-gradient(180deg,#1b2750,#182347); cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.secondary{background:#0e1524}
  .toolbar{padding:12px; border-left:1px solid var(--border)}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
  .toggle{display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
  .switch{width:42px;height:24px;border-radius:999px;background:#263246; position:relative;border:1px solid #31405c}
  .knob{position:absolute; top:2px; left:2px; width:20px;height:20px;border-radius:50%; background:#9aa4b2; transition:.18s all}
  .switch.on{background:linear-gradient(90deg,var(--brand),var(--brand-2))}
  .switch.on .knob{left:20px; background:#fff}
  .small{color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">TamAI ‚Äì bar√°ts√°gos besz√©lget≈ë</div>
      <div class="owner">Az oldalt l√©trehozta: <strong>Horv√°th Tam√°s (Szabolcsb√°ka)</strong>. Kellemes besz√©lget√©st! üéâ</div>
    </header>

    <div class="panel chat">
      <!-- √úZENETEK -->
      <div class="msgs" id="msgs"></div>

      <!-- OLDALS√ÅV / BE√ÅLL√çT√ÅSOK -->
      <aside class="toolbar">
        <div class="row">
          <div class="toggle" id="ttsToggle">
            <div class="switch" id="ttsSwitch"><div class="knob"></div></div>
            <div>üéß Felolvas√°s</div>
          </div>
          <button class="btn secondary" id="stopBtn" title="Felolvas√°s meg√°ll√≠t√°sa">‚èπ Meg√°ll√≠t</button>
        </div>
        <div class="row">
          <label class="small">üéôÔ∏è Hang:</label>
          <select id="voiceSel" class="btn" style="flex:1"></select>
        </div>
        <div class="row">
          <label class="small">üî§ St√≠lus:</label>
          <select id="toneSel" class="btn" style="flex:1">
            <option value="alap">Alap</option>
            <option value="baratsagos">Bar√°ts√°gos</option>
            <option value="vicces">Vicces</option>
            <option value="r√∂vid">Nagyon r√∂vid</option>
          </select>
        </div>
        <div class="small">A felolvas√°s **alapb√≥l ki van kapcsolva**. Kapcsold be, ha szeretn√©d, √©s v√°lassz hangot.</div>
      </aside>

      <!-- INPUT SOR -->
      <div class="inputbar" style="grid-column:1/-1">
        <input id="inp" type="text" placeholder="√çrj ide‚Ä¶ (Enter = k√ºld√©s)" />
        <button id="send" class="btn">K√ºld√©s</button>
      </div>
    </div>
  </div>

<script>
  // ======= KLIENS √ÅLLAPOT =======
  const msgsEl = document.getElementById('msgs');
  const inpEl  = document.getElementById('inp');
  const sendEl = document.getElementById('send');

  const ttsSwitch = document.getElementById('ttsSwitch');
  const ttsToggle = document.getElementById('ttsToggle');
  const stopBtn   = document.getElementById('stopBtn');
  const voiceSel  = document.getElementById('voiceSel');
  const toneSel   = document.getElementById('toneSel');

  let history = [];            // {role:'user'|'assistant', content:'...'}
  let ttsEnabled = false;      // alapb√≥l KI
  let voices = [];

  // ======= UI SEG√âDEK =======
  function addBubble(text, who='assistant'){
    const b = document.createElement('div');
    b.className = 'bubble ' + (who==='user' ? 'me' : 'ai');
    b.textContent = text;
    msgsEl.appendChild(b);
    msgsEl.scrollTop = msgsEl.scrollHeight;
    return b;
  }

  function setSwitch(on){
    ttsEnabled = !!on;
    if(on) ttsSwitch.classList.add('on'); else ttsSwitch.classList.remove('on');
    localStorage.setItem('ttsEnabled', ttsEnabled ? '1' : '0');
  }

  // ======= TTS =======
  function loadVoices(){
    voices = speechSynthesis.getVoices();
    voiceSel.innerHTML = '';
    voices
      .filter(v => v.lang.startsWith('hu') || v.lang.startsWith('en') || v.lang.startsWith('de'))
      .forEach((v,i) => {
        const o = document.createElement('option');
        o.value = v.name; o.textContent = `${v.name} (${v.lang})`;
        voiceSel.appendChild(o);
      });
  }
  if ('speechSynthesis' in window){
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }

  function speak(text){
    if(!ttsEnabled) return;
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel(); // biztons√°g kedv√©√©rt
    const u = new SpeechSynthesisUtterance(text);
    const v = voices.find(v => v.name === voiceSel.value);
    if(v) u.voice = v;
    u.rate = 1.0; u.pitch = 1.0;
    speechSynthesis.speak(u);
  }

  stopBtn.onclick = () => speechSynthesis.cancel();
  ttsToggle.onclick = () => setSwitch(!ttsEnabled);

  // Visszat√∂ltj√ºk a felhaszn√°l√≥ kor√°bbi preferenci√°j√°t
  setSwitch(localStorage.getItem('ttsEnabled') === '1');

  // ======= OPENAI H√çV√ÅS (Netlify function) =======
  async function askOpenAI(message){
    const tone = toneSel.value;
    let sys = "Magyarul v√°laszolj, bar√°ts√°gosan √©s t√∂m√∂ren.";
    if(tone === 'baratsagos') sys = "Magyarul v√°laszolj, nagyon bar√°ts√°gosan √©s k√∂z√©rthet≈ëen.";
    if(tone === 'vicces')     sys = "Magyarul v√°laszolj, k√∂nnyed, kicsit vicces st√≠lusban, de l√©nyegre t√∂r≈ëen.";
    if(tone === 'r√∂vid')      sys = "Magyarul v√°laszolj, a lehet≈ë legr√∂videbben (1-2 mondat).";

    const body = { messages: [{role:'system',content:sys}, ...history, {role:'user',content:message}] };

    const r = await fetch('/.netlify/functions/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!r.ok){
      throw new Error('Szerver hiba: '+r.status);
    }
    const data = await r.json();
    return (data && data.reply) ? data.reply : 'Hmm, most nem tudok v√°laszolni.';
  }

  // ======= K√úLD√âS FOLYAM =======
  async function send(){
    const text = inpEl.value.trim();
    if(!text) return;
    addBubble(text,'user');
    history.push({role:'user', content:text});
    inpEl.value=''; inpEl.focus();

    // "Gondolkodom‚Ä¶" placeholder
    const thinking = addBubble('Gondolkodom‚Ä¶','assistant');

    try{
      const reply = await askOpenAI(text);
      thinking.textContent = reply; // fel√ºl√≠rjuk
      history.push({role:'assistant', content:reply});
      speak(reply);                 // ‚Üê csak akkor, ha ttsEnabled = true
    }catch(e){
      thinking.textContent = 'Hopp, valami hiba t√∂rt√©nt. Pr√≥b√°ld √∫jra.';
      console.error(e);
    }
  }

  sendEl.onclick = send;
  inpEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

  // √ºdv√∂zl≈ë bubor√©k
  addBubble('Szia! √çrj egy √ºzenetet, √©s v√°laszolok. üòä','assistant');
</script>
</body>
</html>

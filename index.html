<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HT ‚Äì Hangos asszistenS</title>
  <meta name="theme-color" content="#0e1118" />
  <style>
    :root{
      --bg1:#0e1118; --bg2:#141a23; --text:#e9edf4; --muted:#aab3c2;
      --border:#22324a; --accent:#ff8a1f; --accent2:#ff5757;
      --shadow:0 12px 32px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 700px at 90% -10%, #1b2540 0%, transparent 60%),
        radial-gradient(900px 600px at -10% 110%, #15362a 0%, transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      background-attachment:fixed; -webkit-font-smoothing:antialiased;
      display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 16px; background:#0f1626; border-bottom:1px solid var(--border);
    }
    .brand{font-weight:800; letter-spacing:.3px; color:var(--accent); font-size:18px}
    .togbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      background:#10182a; border:1px solid var(--border); color:#dfe6f3; cursor:pointer}
    .pill input{accent-color:#ff8a1f; transform:scale(1.05)}
    main{flex:1; display:grid; place-items:center; padding:24px; text-align:center}
    .hint{color:var(--muted); max-width:720px}
    .state{
      margin-top:16px; display:inline-flex; align-items:center; gap:10px;
      background:#121a2a; border:1px solid var(--border); border-radius:12px; padding:10px 14px;
    }
    .dot{width:10px; height:10px; border-radius:50%; background:#666;}
    .dot.on{ background:#2bd48e; box-shadow:0 0 0 6px #2bd48e22 }
    .dot.talk{ background:#ffb256; box-shadow:0 0 0 6px #ffb25622 }
    .fab{position:fixed; right:20px; bottom:20px; z-index:10}
    .fab button{
      width:72px; height:72px; border-radius:50%; border:none; cursor:pointer; color:#111; font-size:28px; font-weight:900;
      background:radial-gradient(circle at 30% 30%,#fff2,#0000), linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .listen{position:fixed; left:16px; bottom:28px; color:var(--muted); font-size:14px}
  </style>
</head>
<body>
  <header>
    <div class="brand">HT ‚Äì Hangos asszisztens</div>
    <div class="togbar">
      <label class="pill" title="Felolvas√°s ki/be">
        <input id="muteMode" type="checkbox" />
        N√©ma
      </label>
      <label class="pill" title="Pro = GPT-4-Turbo (okosabb, dr√°g√°bb)">
        <input id="modelPro" type="checkbox" />
        Pro min≈ës√©g
      </label>
    </div>
  </header>

  <main>
    <div class="hint">
      Koppints a jobb als√≥ üé§ gombra. Egyszer elind√≠tod ‚Üí <b>folyamatosan</b> hallgat √©s v√°laszol, am√≠g le nem √°ll√≠tod.
      iPhone-on is m≈±k√∂dik (szerveroldali √°tirat). A besz√©lget√©s <b>nem jelenik meg</b> a k√©perny≈ën ‚Äì csak sz√≥ban zajlik.
      <div class="state"><span id="dot" class="dot"></span><span id="recState">√Ållapot: inakt√≠v</span></div>
    </div>
  </main>

  <div class="fab"><button id="toggle">üé§</button></div>
  <div class="listen" id="listenHint"></div>

  <script>
    // ========= K√∂z√∂s seg√©dek =========
    const toggleBtn = document.getElementById('toggle');
    const muteCb    = document.getElementById('muteMode');
    const proCb     = document.getElementById('modelPro');
    const stateEl   = document.getElementById('recState');
    const dotEl     = document.getElementById('dot');
    const hintEl    = document.getElementById('listenHint');

    let running=false, recognizing=false, speaking=false;
    function setState(t, mode){ stateEl.textContent='√Ållapot: '+t; dotEl.className='dot'+(mode?' '+mode:''); }
    function voiceMuted(){ return !!muteCb.checked; }
    function isIOS(){
      return /iP(hone|ad|od)/.test(navigator.platform) ||
             (navigator.userAgent.includes("Mac") && "ontouchend" in document);
    }

    // === TTS (magyar) ===
    function speakHu(text){
      if(voiceMuted()) return;
      const u = new SpeechSynthesisUtterance(String(text||''));
      u.lang='hu-HU'; u.rate=1; u.pitch=1;
      try{ speechSynthesis.cancel(); }catch{}
      speaking = true; setState('v√°laszolok‚Ä¶','talk');
      u.onend = ()=>{ speaking=false; if(running) startListening(); else setState('inakt√≠v'); };
      speechSynthesis.speak(u);
    }

    // ======== 1) ANDROID/CHROME (van SpeechRecognition) ========
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

    async function startSR(){
      // enged√©lyk√©r√©s user gesztusra
      await navigator.mediaDevices.getUserMedia({audio:true}).catch(()=>{});
      const rec = new SR();
      rec.lang='hu-HU'; rec.continuous=true; rec.interimResults=false;

      rec.onstart = ()=>{ recognizing=true; setState('hallgatok‚Ä¶','on'); };
      rec.onerror = e => { setState('hiba: '+(e.error||'ismeretlen')); };
      rec.onresult = async (ev)=>{
        const last = ev.results[ev.results.length-1];
        if(!last || !last.isFinal) return;
        const said = (last[0]?.transcript||'').trim();
        if(!said) return;

        // k√©r√©s a szervernek (chat m√≥d, kontextussal)
        const payload = { messages: window._history(), model: proCb.checked ? 'gpt-4-turbo' : 'gpt-4-turbo' };
        payload.messages.push({ role:'user', content: said });
        try{
          const r = await fetch('/.netlify/functions/chat', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          const data = await r.json();
          if(!r.ok || data.error) throw new Error(data.error||('HTTP '+r.status));
          const reply = (data.reply||'').toString().trim() || 'Rendben.';
          window._push({ role:'user', content: said });
          window._push({ role:'assistant', content: reply });
          speakHu(reply);
          // besz√©d alatt √°ll√≠tsuk le a felismer√©st (k√ºl√∂nben visszahallja)
          try{ rec.stop(); recognizing=false; }catch{}
        }catch{ speakHu('Eln√©z√©st, hiba t√∂rt√©nt.'); }
      };
      rec.onend = ()=>{
        recognizing=false;
        if(running && !speaking){
          setTimeout(()=>{ try{ rec.start(); recognizing=true; setState('hallgatok‚Ä¶','on'); }catch{} }, 150);
        }else if(!running){ setState('inakt√≠v'); }
      };

      // indul
      try{ rec.start(); recognizing=true; setState('hallgatok‚Ä¶','on'); }catch{}
      // a vez√©rl≈ë visszaind√≠tja, ha kell
      window._stopSR = ()=>{ try{ rec.stop(); }catch{} };
    }

    // ======== 2) iPHONE / SAFARI (szerveroldali STT ‚Äì Whisper) ========
    let stream=null, mr=null, processing=false;
    function pickMime(){
      const cand = [
        'audio/webm;codecs=opus', 'audio/webm',
        'audio/mp4;codecs=mp4a',  'audio/mp4'
      ];
      for(const m of cand){ if(window.MediaRecorder && MediaRecorder.isTypeSupported(m)) return m; }
      return ''; // hagyja a defaultot
    }
    async function startRecorder(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({audio:true});
      }catch{
        setState('k√©rlek enged√©lyezd a mikrofont (lakat ikon)'); return;
      }
      const mime = pickMime();
      mr = new MediaRecorder(stream, mime ? { mimeType:mime } : {});
      mr.ondataavailable = async (ev)=>{
        if(!running || !ev.data || ev.data.size < 4000) return; // t√∫l kicsi zaj ‚Üí kihagyjuk
        if(processing || speaking) return;
        processing = true; setState('feldolgozom‚Ä¶');

        // blob ‚Üí base64
        const b64 = await blobToBase64(ev.data);
        // k√ºld√©s a szervernek: STT + chat v√°lasz
        try{
          const payload = {
            audio_b64: b64, mime: ev.data.type || 'audio/webm',
            history: window._history(),
            model: proCb.checked ? 'gpt-4-turbo' : 'gpt-4-turbo'
          };
          const r = await fetch('/.netlify/functions/chat', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          const data = await r.json();
          if(!r.ok || data.error) throw new Error(data.error||('HTTP '+r.status));

          // szerver visszaadja: { reply, stt }
          const heard = (data.stt||'').toString().trim();
          const reply = (data.reply||'').toString().trim() || 'Rendben.';
          if(heard) window._push({ role:'user', content: heard });
          window._push({ role:'assistant', content: reply });

          speakHu(reply); // besz√©d ut√°n a vez√©rl√©s √∫jraind√≠tja a hallgat√°st
        }catch{
          speakHu('Eln√©z√©st, hiba t√∂rt√©nt.');
        }finally{
          processing = false;
          if(running && !speaking){ setState('hallgatok‚Ä¶','on'); }
        }
      };
      mr.onstart = ()=>{ recognizing=true; setState('hallgatok‚Ä¶','on'); };
      mr.onstop  = ()=>{ recognizing=false; setState('inakt√≠v'); };
      // 3 m√°sodperces szeletek ‚Äì egyszer≈± ‚Äûkv√°zi-folyamatos‚Äù besz√©dbevitel
      mr.start(3000);
      hintEl.textContent = 'Fut: folyamatos hallgat√°s √©s v√°lasz.';
    }
    function stopRecorder(){
      try{ mr && mr.state!=='inactive' && mr.stop(); }catch{}
      try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch{}
      mr=null; stream=null; processing=false;
      hintEl.textContent = '';
    }
    function blobToBase64(blob){
      return new Promise((res,rej)=>{
        const rd = new FileReader();
        rd.onload = ()=> res((rd.result||'').toString().split(',')[1]||'');
        rd.onerror = rej; rd.readAsDataURL(blob);
      });
    }

    // ======== Egys√©ges vez√©rl√©s ========
    window._conv = [{ role:'system', content:'Mindig magyarul v√°laszolj. L√©gy term√©szetes, k√∂zvetlen √©s tartalmas.' }];
    window._history = ()=> [window._conv[0], ...window._conv.slice(-16)];
    window._push = (m)=> window._conv.push(m);

    toggleBtn.addEventListener('click', async ()=>{
      if(!running){
        running = true;
        setState('ind√≠tom‚Ä¶');
        // ha van SR √©s nem iOS ‚Üí SR, k√ºl√∂nben Recorder+Whisper
        if(SR && !isIOS()){
          await startSR();
        }else{
          await startRecorder();
        }
      }else{
        running = false;
        setState('le√°ll√≠tom‚Ä¶');
        try{ window._stopSR && window._stopSR(); }catch{}
        stopRecorder();
        try{ speechSynthesis.cancel(); }catch{}
        setState('inakt√≠v');
      }
    });

    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='visible' && running && !recognizing && !speaking){
        setState('√∫jraind√≠tom‚Ä¶');
        if(SR && !isIOS()) startSR();
        else startRecorder();
      }
    });

    muteCb.addEventListener('change', ()=>{ if(muteCb.checked){ try{ speechSynthesis.cancel(); }catch{} } });
  </script>
</body>
</html>

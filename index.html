<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HT Chat ‚Äî Kellemes besz√©lget√©st!</title>
  <link rel="icon" href="https://fav.farm/üî•" />
  <style>
    :root{
      --bg1:#0f0f13; --bg2:#12151b; --txt:#e9edf1; --muted:#a9b1bb;
      --brand:#ff7a1a; --brand-2:#ffb457; --glass:rgba(255,255,255,.06);
      --ring:rgba(255,122,26,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      background: radial-gradient(1200px 600px at 10% 10%, #1f2430 0%, transparent 60%),
                  radial-gradient(1200px 600px at 90% 90%, #1b2a3a 0%, transparent 60%),
                  linear-gradient(135deg,var(--bg1),var(--bg2));
      background-attachment: fixed;
      overflow:hidden; /* teljes k√©perny≈ës app-√©lm√©ny */
    }
    /* finom zaj + f√©ny */
    body:before{
      content:""; position:fixed; inset:-20%;
      background:
        radial-gradient(800px 400px at 70% -10%, rgba(255,122,26,.12), transparent 60%),
        radial-gradient(800px 400px at -10% 80%, rgba(255,193,111,.10), transparent 60%);
      filter: blur(20px);
      z-index:-1; animation: float 16s ease-in-out infinite alternate;
    }
    @keyframes float{to{transform: translate3d(0,-20px,0) scale(1.02)}}

    header{
      padding:24px 20px 8px; text-align:center;
    }
    h1{
      margin:0 0 6px; font-weight:800; letter-spacing:.4px;
      text-shadow:0 2px 18px rgba(255,122,26,.25);
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      font-size:clamp(24px,3.8vw,40px);
    }
    .sub{
      color:var(--muted); font-size:14px; opacity:.9;
    }

    .wrap{
      height: calc(100% - 92px);
      padding: 0 18px 18px;
      display:grid; grid-template-rows:auto 1fr auto;
      gap:14px; max-width:980px; margin:0 auto;
    }

    .tools{
      display:flex; gap:10px; align-items:center; justify-content:flex-start;
    }
    .btn{
      border:1px solid rgba(255,255,255,.12); background:var(--glass); color:var(--txt);
      border-radius:999px; padding:10px 14px; font-weight:600; font-size:14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 6px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
      transition:.2s transform, .2s box-shadow, .2s background;
      cursor:pointer; user-select:none;
    }
    .btn:hover{ box-shadow:0 8px 28px rgba(0,0,0,.32), 0 0 0 3px var(--ring);}
    .btn:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none}

    .switch{ display:flex; align-items:center; gap:10px; color:var(--muted); font-size:14px;}
    .switch input{ width:42px; height:24px; appearance:none; background:#2a2f3a; border-radius:999px; position:relative; outline:none; cursor:pointer; transition:.2s background}
    .switch input:checked{ background:#334050}
    .switch input:before{
      content:""; position:absolute; width:18px; height:18px; border-radius:50%;
      top:3px; left:3px; background:#fff; transform:translateX(0); transition:.2s transform;
      box-shadow:0 2px 8px rgba(0,0,0,.35);
    }
    .switch input:checked:before{ transform: translateX(18px); }

    .chat{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
      padding: 16px;
      overflow: hidden;
      display:flex; flex-direction:column;
      min-height: 0; /* g√∂rget√©shez fontos */
    }
    #messages{
      overflow:auto; flex:1 1 auto; padding-right:6px;
      scroll-behavior:auto; /* manu√°lis kontroll */
    }
    .msg{
      max-width:min(680px, 92%);
      margin: 6px 0; padding:12px 14px; border-radius:14px;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.09);
      box-shadow: 0 4px 18px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.04);
      backdrop-filter: blur(8px);
    }
    .msg.me{
      margin-left:auto; background: rgba(255,122,26,.15);
      border-color: rgba(255,122,26,.35);
    }
    .msg.error{
      background: rgba(255, 75, 75,.15);
      border-color: rgba(255, 75, 75,.35);
      color:#ffd7d7;
    }
    .msg small{ color:var(--muted); display:block; margin-top:6px; font-size:12px }

    .composer{
      display:flex; gap:10px; align-items:flex-end; padding-top:4px;
    }
    textarea{
      flex:1 1 auto; resize:none; min-height:44px; max-height:160px;
      background: rgba(255,255,255,.06);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.1); border-radius:14px;
      padding:12px 14px; outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    textarea:focus{ box-shadow: 0 0 0 3px var(--ring), inset 0 1px 0 rgba(255,255,255,.05);}
    .send{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#111; border:none; }
  </style>
</head>
<body>
  <header>
    <h1>HT Chat ‚Äî Kellemes besz√©lget√©st! ü•≥</h1>
    <div class="sub">Az oldalt l√©tre hozta <strong>H.T</strong> ‚Äî egyedi fejleszt√©ssel.</div>
  </header>

  <main class="wrap">
    <!-- eszk√∂zt√°r -->
    <div class="tools">
      <button id="copyLast" class="btn">M√°sol√°s (utols√≥ v√°lasz)</button>
      <label class="switch"><input id="ttsToggle" type="checkbox" /> Hang (felolvas√°s)</label>
    </div>

    <!-- chat doboz -->
    <section class="chat">
      <div id="messages" aria-live="polite">
        <div class="msg">Szia! √çrj egy √ºzenetet, √©s v√°laszolok. üòä</div>
      </div>

      <!-- szerz≈ë inf√≥ ‚Äì fix v√°laszk√©nt is megjelen√≠thet≈ë -->
      <div style="display:none" id="authorText">
        Az oldalt l√©trehozta Horv√°th Tam√°s (Szabolcsb√°ka). Kellemes besz√©lget√©st!
      </div>

      <div class="composer">
        <textarea id="input" placeholder="√çrj ide‚Ä¶"></textarea>
        <button id="sendBtn" class="btn send">K√ºld√©s</button>
      </div>
    </section>
  </main>

  <script>
    const $msgs  = document.getElementById('messages');
    const $input = document.getElementById('input');
    const $send  = document.getElementById('sendBtn');
    const $copy  = document.getElementById('copyLast');
    const $tts   = document.getElementById('ttsToggle');

    let lastReply = "";

    function addMsg(text, who='bot'){
      const el = document.createElement('div');
      el.className = `msg ${who}`;
      el.textContent = text;

      // csak akkor autog√∂rget, ha k√∂zel volt√°l az alj√°hoz
      const nearBottom = ($msgs.scrollHeight - $msgs.scrollTop - $msgs.clientHeight) < 120;

      $msgs.appendChild(el);
      if (nearBottom) $msgs.scrollTop = $msgs.scrollHeight;
    }
    function addError(text){
      const el = document.createElement('div');
      el.className = 'msg error';
      el.textContent = text;
      $msgs.appendChild(el);
      $msgs.scrollTop = $msgs.scrollHeight;
    }

    async function send(){
      const text = ($input.value||"").trim();
      if(!text) return;

      // UI lock
      $send.disabled = true; $input.disabled = true;

      addMsg(text,'me');
      $input.value = "";

      // gy≈±jts√ºnk r√∂vid el≈ëzm√©nyt (max 10)
      const nodes = Array.from($msgs.querySelectorAll('.msg'));
      const last10 = nodes.slice(-10);
      const messages = last10.map(n=>({
        role: n.classList.contains('me') ? 'user' : 'assistant',
        content: n.textContent
      }));

      // 25s timeout
      const ctrl = new AbortController();
      const to = setTimeout(()=>ctrl.abort(), 25000);

      try{
        const r = await fetch('/.netlify/functions/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ messages }),
          signal: ctrl.signal
        });

        if(!r.ok){
          let msg = `HTTP ${r.status}`;
          try { msg = await r.text(); } catch {}
          addError(`Hiba: ${msg}`);
          return;
        }
        const data = await r.json();
        const reply = (data.reply || "Rendben.").trim();
        lastReply = reply;
        addMsg(reply,'bot');

        if($tts.checked && window.speechSynthesis){
          const u = new SpeechSynthesisUtterance(reply);
          u.lang = 'hu-HU';
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        }
      }catch(e){
        addError(e.name === 'AbortError' ? "Id≈ët√∫ll√©p√©s ‚Äì pr√≥b√°ld √∫jra."
                                         : `H√°l√≥zati hiba: ${e.message}`);
      }finally{
        clearTimeout(to);
        $send.disabled = false; $input.disabled = false; $input.focus();
      }
    }

    // esem√©nyek
    $send.addEventListener('click', send);
    $input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });

    $copy.addEventListener('click', async ()=>{
      if(!lastReply) return;
      try{
        await navigator.clipboard.writeText(lastReply);
        $copy.textContent = "Kim√°solva!";
      }catch{
        $copy.textContent = "M√°sol√°si hiba";
      }
      setTimeout(()=>{ $copy.textContent = "M√°sol√°s (utols√≥ v√°lasz)"; }, 1200);
    });
  </script>
</body>
</html>

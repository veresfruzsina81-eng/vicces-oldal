<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HT Chat ‚Äî Kellemes besz√©lget√©st!</title>
  <meta name="theme-color" content="#0e1118" />
  <style>
    :root{
      --bg1:#0e1118; --bg2:#141a23; --text:#e9edf4; --muted:#aab3c2;
      --border:#22324a; --accent:#ff8a1f; --accent2:#ffb256; --err:#ff6b6b;
      --shadow:0 12px 32px rgba(0,0,0,.35); --r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 700px at 90% -10%, #1b2540 0%, transparent 60%),
        radial-gradient(900px 600px at -10% 110%, #15362a 0%, transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      background-attachment:fixed;
    }
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    header{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    h1{margin:0;font-size:clamp(28px,4.2vw,46px);color:var(--accent);text-shadow:0 2px 0 #0007}
    .sub{color:var(--muted)}

    /* Chat k√°rtya */
    .card{
      background:linear-gradient(180deg,#1a2336,#0f1626);
      border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow); padding:12px;
    }
    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:8px 6px}
    .switch{display:inline-flex;gap:8px;align-items:center;background:#0e1728;border:1px solid var(--border);padding:8px 10px;border-radius:999px}
    .switch input{accent-color:var(--accent);transform:scale(1.08)}
    .tip{margin-left:auto;color:var(--muted);font-size:.95rem}

    .chat{
      height:min(72vh,760px);overflow:auto;padding:10px;scroll-behavior:smooth;
      background:#0c1424;border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;
    }
    .row{display:flex;margin:10px 0}
    .row.user{justify-content:flex-end}
    .row.info{justify-content:center}
    .bubble{
      max-width:78%;padding:12px 14px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.06);backdrop-filter:blur(6px)
    }
    .row.user .bubble{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#1b1209;border:none}
    .row.err .bubble{background:#3a1f24;border-color:#6a2b36}
    .row.info .bubble{background:#142a22;border-color:#1d6d4e}

    .inputbar{display:flex;gap:10px;align-items:center;margin-top:10px;background:#0b1426;border:1px solid var(--border);border-radius:12px;padding:8px}
    .inputbar input{flex:1;background:transparent;border:none;outline:none;color:var(--text);padding:10px;font-size:1rem}
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#1b1209;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Lebeg≈ë mikrofon + MODAL */
    .fab{position:fixed;right:20px;bottom:20px;z-index:50}
    .fab button{
      width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;color:#111;font-size:24px;font-weight:900;
      background:radial-gradient(circle at 30% 30%,#fff2,#0000),linear-gradient(135deg,#ff8a1f,#ff5757);
      box-shadow:0 14px 36px rgba(0,0,0,.45);
    }
    .modal{position:fixed;inset:0;z-index:60;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
    .modal.open{display:flex}
    .sheet{
      width:min(560px,94vw);background:linear-gradient(180deg,#162035,#0f1523);
      border:1px solid var(--border);border-radius:20px;box-shadow:0 28px 60px rgba(0,0,0,.55);
      padding:18px;color:var(--text);display:grid;gap:14px;animation:pop .18s ease-out both;
    }
    @keyframes pop{from{transform:scale(.98);opacity:0}to{transform:scale(1);opacity:1}}
    .sheet header{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .xbtn{background:#0f1626;border:1px solid var(--border);color:#dfe6f3;border-radius:10px;padding:8px 12px;cursor:pointer}
    .rowc{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    .micwrap{display:grid;place-items:center;padding:6px;margin:6px 0}
    .micbtn{
      width:120px;height:120px;border-radius:50%;border:none;cursor:pointer;color:#111;font-size:28px;font-weight:900;
      background:radial-gradient(circle at 30% 30%,#fff3,#0000),linear-gradient(135deg,#ff8a1f,#ff5757);
      box-shadow:0 18px 50px rgba(0,0,0,.45), inset 0 1px 0 #ffffff66;transition:transform .1s ease
    }
    .micbtn:active{transform:scale(.98)}
    .pulse{position:relative}
    .pulse::after{
      content:"";position:absolute;inset:-10px;border-radius:999px;border:2px solid #ff8a1f99;opacity:.7;
      animation:pulse 1.6s ease-out infinite;
    }
    .tog{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#10182a;border:1px solid var(--border);cursor:pointer}
    .tog input{accent-color:var(--accent);transform:scale(1.1)}
    .hint{color:var(--muted);font-size:.95rem}

    @media (max-width:720px){
      .chat{height:66vh}
      .bubble{max-width:88%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>HT Chat ‚Äî Kellemes besz√©lget√©st! ü•≥</h1>
      <div class="sub">Az oldalt l√©trehozta <strong>H.T</strong> ‚Äî egyedi fejleszt√©ssel.</div>
    </header>

    <section class="card">
      <div class="toolbar">
        <label class="switch"><input id="copyToggle" type="checkbox"> M√°sol√°s (utols√≥ v√°lasz)</label>
        <label class="switch"><input id="ttsToggle" type="checkbox"> Hang (felolvas√°s)</label>
        <span class="tip">Tipp: Enter = k√ºld√©s, Shift+Enter = √∫j sor</span>
      </div>

      <div id="chat" class="chat" aria-live="polite"></div>

      <form id="form" class="inputbar" autocomplete="off">
        <input id="msg" placeholder="√çrj ide‚Ä¶" />
        <button class="btn">K√ºld√©s</button>
      </form>
    </section>
  </div>

  <!-- Lebeg≈ë mikrofon gomb -->
  <div class="fab"><button id="openVoice" title="Hangos asszisztens">üé§</button></div>

  <!-- Modern felugr√≥ (modal) Voice UI -->
  <div id="voiceModal" class="modal" role="dialog" aria-label="Hangos asszisztens">
    <div class="sheet">
      <header>
        <div style="font-weight:800;letter-spacing:.3px">Hangos asszisztens ‚Äî magyar</div>
        <button class="xbtn" id="closeVoice">Bez√°r</button>
      </header>

      <div class="micwrap">
        <button id="mic" class="micbtn" title="Ind√≠t√°s / Le√°ll√≠t√°s">üéôÔ∏è</button>
      </div>

      <div class="rowc">
        <label class="tog"><input id="autoListenToggle" type="checkbox"> Folyamatos m√≥d</label>
        <label class="tog"><input id="muteMode" type="checkbox"> N√©ma (ne olvassa fel)</label>
        <label class="tog" title="Mini = gpt-4o-mini, Pro = gpt-4o"><input id="modelPro" type="checkbox"> Pro min≈ës√©g</label>
      </div>

      <div class="hint" id="recState">√Ållapot: inakt√≠v. Tipp: Chrome/Edge + HTTPS. Els≈ë ind√≠t√°skor enged√©lyezd a mikrofont!</div>
    </div>
  </div>

  <script>
    /* ======== Chat (√≠r√°s) ======== */
    const chat = document.getElementById('chat');
    const form = document.getElementById('form');
    const msg  = document.getElementById('msg');
    const copyToggle = document.getElementById('copyToggle');
    const ttsToggle  = document.getElementById('ttsToggle');

    function addRow(text, who='bot'){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='user'?'user':(who==='info'?'info':(who==='err'?'err':'')));
      const b = document.createElement('div'); b.className='bubble'; b.textContent = text;
      row.appendChild(b); chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
      if (who==='bot' && ttsToggle.checked && !voiceMuted()) speakHu(text);
    }

    addRow('Szia! √çrj b√°tran, miben seg√≠thetek? Itt vagyok neked, seg√≠tek b√°rmiben. üòä','info');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (msg.value||'').trim(); if(!text) return;
      addRow(text,'user'); msg.value='';

      try{
        const r = await fetch('/.netlify/functions/chat', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text })
        });
        let data; try{ data = await r.json(); }catch{ data=null; }
        if(!r.ok || data?.error){ addRow('Hiba: '+(data?.error || `HTTP ${r.status}`),'err'); return; }
        const answer = (data?.reply ?? '').toString().trim();
        addRow(answer || '√ârtem. Miben seg√≠thetek m√©g?','bot');
        if(copyToggle.checked){ try{ await navigator.clipboard.writeText(answer||''); }catch{} }
      }catch(err){ addRow('H√°l√≥zati hiba: '+(err.message||err),'err'); }
    });

    function voiceMuted(){ return document.getElementById('muteMode')?.checked; }
    function speakHu(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'hu-HU'; u.rate = 1; u.pitch = 1;
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch{}
    }

    /* ======== VOICE-ONLY, folyamatos besz√©lget√©s (nincs ki√≠r√°s) ======== */
    const openVoice = document.getElementById('openVoice');
    const voiceModal= document.getElementById('voiceModal');
    const closeVoice= document.getElementById('closeVoice');
    const micBtn    = document.getElementById('mic');
    const autoToggle= document.getElementById('autoListenToggle');
    const muteCb    = document.getElementById('muteMode');
    const modelPro  = document.getElementById('modelPro');
    const recState  = document.getElementById('recState');

    openVoice.addEventListener('click', ()=> voiceModal.classList.add('open'));
    function closeModal(){ voiceModal.classList.remove('open'); stopVoiceAll(); }
    closeVoice.addEventListener('click', closeModal);
    voiceModal.addEventListener('click', (e)=>{ if(e.target===voiceModal) closeModal(); });

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec=null, recognizing=false, autoOn=false;
    function setRecState(t){ recState.textContent = '√Ållapot: ' + t; }

    // besz√©lget√©si el≈ëzm√©ny (okosabb v√°laszok)
    let vmHistory = [
      { role: "system", content: "Mindig magyarul v√°laszolj. L√©gy term√©szetes, k√∂zvetlen √©s tartalmas." }
    ];
    // csak az utols√≥ ~8 p√°rbesz√©det k√ºldj√ºk
    const shortHistory = () => [vmHistory[0], ...vmHistory.slice(-16)];

    function ensureRec(){
      if(!SR){ setRecState('nem t√°mogatott (Chrome/Edge aj√°nlott)'); micBtn.disabled=true; return null; }
      if(rec) return rec;
      rec = new SR();
      rec.lang='hu-HU'; rec.continuous=true; rec.interimResults=false;
      rec.onstart = ()=>{ recognizing=true; micBtn.classList.add('pulse'); setRecState('hallgatok‚Ä¶'); };
      rec.onerror = e => { setRecState('hiba: '+(e.error||'ismeretlen')); };
      rec.onresult = (ev)=>{
        const last = ev.results[ev.results.length-1];
        if(!last || !last.isFinal) return;
        const said = (last[0]?.transcript || '').trim();
        if(!said) return;
        askVoice(said).catch(()=> speakHu('H√°l√≥zati hiba t√∂rt√©nt.'));
      };
      rec.onend = ()=>{
        recognizing=false; micBtn.classList.remove('pulse');
        setRecState(autoOn ? '√∫jraind√≠tom‚Ä¶' : 'inakt√≠v');
        if(autoOn){ setTimeout(()=>{ try{ rec.start(); recognizing=true; }catch{} }, 150); }
      };
      return rec;
    }

    async function startListening(){
      const inst = ensureRec(); if(!inst) return;
      try{
        await navigator.mediaDevices.getUserMedia({audio:true});
        try{ speechSynthesis.cancel(); }catch{}
        try{ inst.start(); recognizing=true; setRecState('hallgatok‚Ä¶'); }catch{}
      }catch{ setRecState('k√©rlek enged√©lyezd a mikrofont (lakat ikon)'); }
    }
    function stopListening(){ try{ rec && rec.stop(); }catch{} recognizing=false; setRecState('inakt√≠v'); }
    function startVoiceContinuous(){ autoOn=true; startListening(); }
    function stopVoiceAll(){ autoOn=false; stopListening(); }

    // TTS: v√°lasz ut√°n automatikus visszahallgat√°s
    function speakHuVoice(text){
      if (voiceMuted()) return;
      try{
        const u = new SpeechSynthesisUtterance(String(text||''));
        u.lang='hu-HU'; u.rate=1; u.pitch=1;
        try{ rec && recognizing && rec.stop(); }catch{}
        speechSynthesis.cancel();
        u.onend = ()=>{ if(autoOn) startListening(); };
        speechSynthesis.speak(u);
      }catch{}
    }

    // Voice ‚Üí k√©r√©s a szerver fel√©, el≈ëzm√©ny + modell v√°laszt√≥
    async function askVoice(userText){
      vmHistory.push({ role:'user', content:userText });
      const payload = { messages: shortHistory() };
      // ha ‚ÄûPro min≈ës√©g‚Äù be van kapcsolva, k√©rj√ºnk 4o-t (backendnek ezt le kell kezelnie)
      if(modelPro.checked) payload.model = 'gpt-4o';

      const r = await fetch('/.netlify/functions/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      let data=null; try{ data = await r.json(); }catch{}
      if(!r.ok || data?.error){ speakHuVoice('Eln√©z√©st, hiba t√∂rt√©nt.'); return; }
      const reply = (data.reply||'').toString().trim() || 'Rendben.';
      vmHistory.push({ role:'assistant', content: reply });
      speakHuVoice(reply);
    }

    // UI esem√©nyek
    micBtn.addEventListener('click', ()=>{ (!recognizing && !autoOn) ? startListening() : stopVoiceAll(); });
    autoToggle.addEventListener('change', ()=>{ autoToggle.checked ? startVoiceContinuous() : stopVoiceAll(); });
    muteCb.addEventListener('change', ()=>{ if(muteCb.checked){ try{ speechSynthesis.cancel(); }catch{} } });

  </script>
</body>
</html>

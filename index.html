<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tam√°s Mesters√©ges (AI)</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --panel:#0f1620cc; --text:#e8eef6; --muted:#9fb0c3;
      --bubbleUser:#ffb84d; --bubbleBot:#243447; --bubbleInfo:#1b2838;
      --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    html,body{height:100%;overflow:hidden}
    body{
      margin:0; color:var(--text);
      font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      position:relative; height:100svh; touch-action:manipulation; -webkit-text-size-adjust:100%;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background: radial-gradient(rgba(0,0,0,.58), rgba(0,0,0,.58)),
                  url("/bg_tamas.jpg") center 30% / cover no-repeat;
    }
    header{ text-align:center; margin:8px 0 6px; }
    header .ttl{ font-weight:800; font-size:20px; letter-spacing:.3px; }
    header .sub{ color:var(--muted); font-size:12px; margin-top:2px; }

    .card{
      width:min(1000px,94vw); height:78svh;
      background:var(--panel); border:1px solid rgba(255,255,255,.08);
      border-radius:22px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .chatlog{
      flex:1; overflow-y:auto; padding:14px;
      -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      scroll-behavior:smooth;
    }
    .row{display:flex; margin:10px 0}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .row.info{justify-content:center}
    .bubble{
      max-width:min(640px,92%); padding:14px 16px; border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      word-wrap:break-word; white-space:pre-wrap;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .bot .bubble{background:var(--bubbleBot)}
    .user .bubble{background:var(--bubbleUser); color:#1f1200}
    .info .bubble{background:var(--bubbleInfo); color:var(--muted)}
    .chatlog img{ max-width:55%; border-radius:12px; display:block; margin:8px auto; }

    .composer{display:flex; align-items:center; gap:10px; padding:10px; background:rgba(0,0,0,.5)}
    .input{
      flex:1; display:flex; align-items:center; gap:10px;
      padding:10px 14px; background:#0f1620bf;
      border:1px solid rgba(255,255,255,.12); border-radius:14px;
    }
    .input input{ flex:1; border:0; outline:none; background:transparent; color:var(--text); font-size:15px }
    .icon-btn{
      min-width:40px; height:40px; border:0; border-radius:10px;
      background:#11182780; color:var(--text); cursor:pointer;
    }
    .send{
      border:0; cursor:pointer; font-weight:800; color:#331d00;
      background:linear-gradient(90deg,#ffb84d,#ffa53a);
      padding:10px 16px; border-radius:14px; white-space:nowrap;
    }
    footer{ margin-top:8px; font-size:12px; color:var(--muted); text-align:center; user-select:none; pointer-events:none }
  </style>
</head>
<body>
  <header>
    <div class="ttl">Tam√°s Mesters√©ges (AI)</div>
    <div class="sub">Halad√≥ fejleszt√©s ‚Äî bar√°ts√°gos magyar asszisztens</div>
  </header>

  <section class="card">
    <div id="log" class="chatlog">
      <div class="row bot info">
        <div class="bubble">Szia! Itt vagyok neked, seg√≠tek mindenben. √çrj b√°tran! üòä</div>
      </div>
    </div>

    <div class="composer">
      <div class="input">
        <input id="txt" autocomplete="off" placeholder="√çrj ide‚Ä¶   Enter = k√ºld√©s, Shift+Enter = √∫j sor" />
        <input id="imgInput" type="file" accept="image/*" style="display:none" />
        <button class="icon-btn" id="uploadBtn" title="K√©p felt√∂lt√©s">üì∑</button>
        <button class="icon-btn" id="ttsBtn" title="Felolvas√°s">üîä</button>
      </div>
      <button class="send" id="sendBtn">K√ºld√©s</button>
    </div>
  </section>

  <footer>¬© Tam√°s AI ‚Äî v√©dett oldal. B√°rmilyen m√°sol√°s jogs√©rt√©snek min≈ës√ºl.</footer>

  <script>
    const log = document.getElementById('log');
    const txt = document.getElementById('txt');
    const sendBtn = document.getElementById('sendBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const imgInput = document.getElementById('imgInput');

    function addRow(kind, html){
      const r=document.createElement('div'); r.className='row '+kind;
      const b=document.createElement('div'); b.className='bubble';
      b.innerHTML=html; r.appendChild(b); log.appendChild(r);
      log.scrollTop=log.scrollHeight; return r;
    }

    async function compressToDataURL(file, maxW=1280, quality=0.85){
      const fr = new FileReader();
      const dataURL = await new Promise((res,rej)=>{ fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
      const img = new Image(); img.src = dataURL;
      await new Promise(r=>img.onload=r);
      const scale = Math.min(1, maxW/img.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(img.width*scale);
      canvas.height = Math.round(img.height*scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      return canvas.toDataURL('image/jpeg', quality);
    }

    async function sendToServer(message, imageBase64){
      const r = await fetch('/.netlify/functions/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message, image: imageBase64 })
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    async function ask(text){
      const message = (text ?? txt.value || '').trim();
      if(!message) return;
      addRow('user', message);
      txt.value='';
      const think = addRow('bot','<i>Gondolkodom‚Ä¶</i>');
      try{
        const data = await sendToServer(message, null);
        think.remove();
        addRow('bot', (data.reply||'').trim() || 'Rendben. üôÇ');
      }catch(e){
        think.remove();
        addRow('bot','Hiba t√∂rt√©nt. Pr√≥b√°ld √∫jra kicsit k√©s≈ëbb. üôÇ');
      }
    }

    // ---- gombok
    sendBtn.addEventListener('click', ()=>ask());
    txt.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(); }
    });

    // ---- k√©p felt√∂lt√©s teljes folyamat
    uploadBtn.addEventListener('click', ()=> imgInput.click());
    imgInput.addEventListener('change', async ()=>{
      const file = imgInput.files && imgInput.files[0];
      if(!file) return;
      try{
        const b64 = await compressToDataURL(file);
        // el≈ën√©zet a saj√°t bubor√©kban
        addRow('user', `<img src="${b64}" alt="Felt√∂lt√∂tt k√©p">`);
        // ‚ÄûGondolkodom‚Äù jelz≈ë
        const think = addRow('bot','<i>Gondolkodom‚Ä¶</i>');
        // elk√ºld√©s a szervernek (k√©p + opcion√°lis √ºzenet)
        const data = await sendToServer('', b64);
        think.remove();
        addRow('bot', (data.reply||'').trim() || 'Sz√©p k√©p! üôÇ');
      }catch(e){
        addRow('bot','Nem siker√ºlt feldolgozni a k√©pet. Pr√≥b√°ld meg kisebb f√°jllal. üì∑');
      }finally{
        imgInput.value = ''; // reset
      }
    });
  </script>
</body>
</html>

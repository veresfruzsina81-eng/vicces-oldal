<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HT Chat ‚Äî Kellemes besz√©lget√©st!</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    /* ======= Alapok + 3D ‚Äú√ºveges‚Äù h√°tt√©r ======= */
    :root{
      --bg1:#0b0f17; --bg2:#131a26; --glass:#111722cc;
      --primary:#ff8a00; --primary-2:#ffa841;
      --text:#e9edf5; --muted:#a9b4c7; --chip:#202a3a;
      --ok:#1ec28b; --err:#ff5d6c;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text); background: radial-gradient(1200px 700px at 80% 10%, #1c2638 0%, #0b0f17 40%) no-repeat;
      overflow-y:auto; -webkit-font-smoothing:antialiased; line-height:1.45;
    }
    /* anim√°lt ‚Äú3D‚Äù f√©nyfolt */
    body::before{
      content:""; position:fixed; inset:-20% -10% auto -10%; height:60vh; z-index:-1;
      background:radial-gradient(closest-side at 30% 40%, rgba(255,138,0,.25), transparent 70%),
                 radial-gradient(closest-side at 70% 20%, rgba(76,161,255,.18), transparent 65%);
      filter:blur(40px); transform:translateZ(0); animation:float 18s ease-in-out infinite alternate;
    }
    @keyframes float{from{transform:translate3d(-2%,0,0)} to{transform:translate3d(2%, -1%,0)}}

    .wrap{
      max-width:1100px; margin:0 auto; padding:22px clamp(14px,3vw,26px) 28px;
      display:flex; flex-direction:column; gap:18px;
    }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
    }
    h1{margin:0; font-size:clamp(26px,4.8vw,42px); letter-spacing:.3px}
    .badge{
      font-weight:700; color:var(--primary); text-shadow:0 2px 12px rgba(255,138,0,.25);
    }
    .sub{
      font-size:14px; color:var(--muted);
    }

    /* Vez√©rl≈ësor */
    .controls{
      display:flex; flex-wrap:wrap; gap:12px;
      background:linear-gradient(180deg, #121a27, #0f1723);
      padding:12px; border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid #1f2b3f;
    }
    .chip, .btn{
      background:var(--chip); border:1px solid #253146; color:var(--text);
      border-radius:12px; padding:10px 12px; display:inline-flex; align-items:center; gap:10px;
      cursor:pointer; user-select:none; transition:.15s ease; min-height:40px;
    }
    .chip:hover, .btn:hover{transform:translateY(-1px); background:#26344a}
    .switch{display:flex; align-items:center; gap:10px}
    .switch input{accent-color:var(--primary)}

    .btn.primary{background:linear-gradient(180deg, var(--primary), var(--primary-2)); color:#171717; border:none; font-weight:700}
    .btn.primary:hover{filter:saturate(1.08) brightness(1.02)}

    /* K√©t k√°rtya: Chat + Voice */
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, #0e1420, #0b101a);
      border:1px solid #1d293b; border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden; display:flex; flex-direction:column; min-height:420px;
    }
    .card h2{margin:0; padding:14px 16px; border-bottom:1px solid #1c283a; font-size:18px}
    .card-body{padding:12px; display:flex; flex-direction:column; gap:10px}

    /* Chat panel ‚Äì fix magass√°g, bels≈ë scroll; mobilon rugalmas */
    .chat-shell{display:flex; flex-direction:column; gap:12px; min-height:420px}
    .msgs{
      flex:1 1 auto; min-height:260px; max-height:58vh; overflow:auto; padding:4px 6px 4px 4px;
      scroll-behavior:smooth; border-radius:12px; background:rgba(255,255,255,.02); border:1px solid #1a2436;
    }
    .msg{max-width:90%; padding:10px 12px; margin:8px; border-radius:14px; box-shadow:0 4px 16px rgba(0,0,0,.22); border:1px solid #1b2537}
    .msg.user{margin-left:auto; background:linear-gradient(180deg,#3a2b1a,#2a2118); color:#ffdcb6; border-color:#46331c}
    .msg.bot{background:linear-gradient(180deg,#101724,#0f1622)}
    .msg.info{background:#1b2435; color:#a9b4c7}
    .msg.err{background:#2b1216; border-color:#4e1e24; color:#ffd8dc}

    .inputRow{display:flex; gap:8px; align-items:center; padding:4px 2px}
    textarea{
      flex:1 1 auto; resize:none; min-height:38px; max-height:140px; padding:10px 12px; color:var(--text);
      background:#0f1623; border:1px solid #22304a; outline:none; border-radius:12px;
    }
    textarea:focus{border-color:#2c3f63; box-shadow:0 0 0 3px rgba(76,161,255,.15)}
    .send{min-width:92px}

    /* Voice box */
    .status{font-size:13px; color:var(--muted)}
    .status b{color:var(--text)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:#162133; border:1px solid #21304a; font-size:13px}

    /* Mobil finomhangol√°s */
    @media (max-width:720px){
      .controls{gap:8px}
      .msgs{max-height:55vh}
      .send{min-width:84px}
      .chip, .btn{min-height:44px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1><span class="badge">HT Chat</span> ‚Äî Kellemes besz√©lget√©st! ü•≥</h1>
      </div>
      <div class="sub">Az oldalt l√©tre hozta <b>H.T</b> ‚Äî egyedi fejleszt√©ssel.</div>
    </header>

    <!-- Vez√©rl≈ëk -->
    <div class="controls">
      <button id="copyBtn" class="chip">üìã M√°sol√°s (utols√≥ v√°lasz)</button>
      <label class="switch chip">
        <input id="ttsToggle" type="checkbox" />
        <span>üîà Hang (felolvas√°s)</span>
      </label>
      <span class="pill">Tipp: Enter = k√ºld√©s, Shift+Enter = √∫j sor</span>
    </div>

    <div class="grid">
      <!-- Chat k√°rtya (kisebb, bels≈ë scroll) -->
      <section class="card">
        <h2>üí¨ Besz√©lget√©s</h2>
        <div class="card-body">
          <div id="msgs" class="msgs"></div>
          <form id="form" class="inputRow">
            <textarea id="input" placeholder="√çrj ide..." rows="1"></textarea>
            <button class="btn primary send" type="submit">K√ºld√©s</button>
          </form>
        </div>
      </section>

      <!-- Hangos besz√©l≈ë m√≥d ugyanazon az oldalon -->
      <section class="card">
        <h2>üéôÔ∏è Hangos besz√©l≈ë m√≥d</h2>
        <div class="card-body">
          <div class="status">
            Magyar nyelv felismer√©s √©s felolvas√°s (k√≠s√©rleti).  
            <br>Ha r√°k√©rdeznek: <i>‚Äûki hozta l√©tre az oldalt?‚Äù</i> ‚Üí v√°lasz: <b>‚ÄûAz oldalt l√©trehozta Horv√°th Tam√°s (Szabolcsb√°ka). Kellemes besz√©lget√©st!‚Äù</b>
          </div>
          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
            <button id="recStart" class="btn">‚ñ∂Ô∏è Felismer√©s ind√≠t</button>
            <button id="recStop" class="btn">‚èπ Meg√°ll√≠t</button>
            <span id="recState" class="pill">√Ållapot: <b>inakt√≠v</b></span>
          </div>
          <div style="margin-top:12px" class="pill">A felolvas√°s a fenti ‚ÄúHang (felolvas√°s)‚Äù kapcsol√≥val vez√©relhet≈ë.</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ====== Seg√©dek ======
    const $ = sel => document.querySelector(sel);
    const msgsEl = $("#msgs");
    const inputEl = $("#input");
    const formEl = $("#form");
    const copyBtn = $("#copyBtn");
    const ttsToggle = $("#ttsToggle");
    let lastBot = "";
    let autoStick = true;  // csak akkor g√∂rget√ºnk le, ha a user ‚Äúalul van‚Äù

    // figyelj√ºk, hogy a user alul van-e
    function isNearBottom(el, px=40){
      return el.scrollTop + el.clientHeight >= el.scrollHeight - px;
    }
    msgsEl.addEventListener("scroll", ()=>{ autoStick = isNearBottom(msgsEl); });

    function addMsg(text, who="bot", isRaw=false){
      const div = document.createElement("div");
      div.className = "msg " + (who==="user"?"user":(who==="err"?"err":"bot"));
      div.innerHTML = isRaw ? text : escapeHtml(text).replace(/\n/g,"<br>");
      msgsEl.appendChild(div);
      if (autoStick) msgsEl.scrollTop = msgsEl.scrollHeight;
      return div;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    // ====== TTS (felolvas√°s) ======
    function speakHu(text){
      if(!ttsToggle.checked) return;
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "hu-HU";
        u.rate = 1; u.pitch = 1;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(_){}
    }

    // ====== M√°sol√°s ======
    copyBtn.addEventListener("click", async ()=>{
      try{
        if (!lastBot) return;
        await navigator.clipboard.writeText(lastBot);
        copyBtn.textContent = "‚úÖ Kim√°solva";
        setTimeout(()=>copyBtn.textContent="üìã M√°sol√°s (utols√≥ v√°lasz)", 1200);
      }catch(e){ alert("M√°sol√°s nem siker√ºlt: "+e.message); }
    });

    // ====== Chat k√ºld√©s ======
    formEl.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const text = (inputEl.value || "").trim();
      if(!text) return;

      addMsg(text, "user");
      inputEl.value = ""; inputEl.style.height="auto";

      try{
        const r = await fetch("/.netlify/functions/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ message: text })
        });

        if(!r.ok){
          const t = await r.text();
          throw new Error("HTTP "+r.status+" ‚Äì "+t.slice(0,140));
        }
        const data = await r.json();
        const reply = (data.reply || "").toString();

        // (v√©d≈ë) sablon a ‚Äúki hozta l√©tre‚Ä¶‚Äù k√©rd√©sekre ‚Äì ha a backend nem adn√°
        const low = text.toLowerCase();
        const trigger = ["ki hozta l√©tre", "ki az oldal k√©sz√≠t≈ëje", "ki k√©sz√≠tette"];
        if (trigger.some(k => low.includes(k))){
          lastBot = "Az oldalt l√©trehozta Horv√°th Tam√°s (Szabolcsb√°ka). Kellemes besz√©lget√©st!";
        } else {
          lastBot = reply || "Rendben, sz√≠vesen seg√≠tek. Miben seg√≠thetek m√©g?";
        }

        addMsg(lastBot, "bot");
        speakHu(lastBot);
      }catch(err){
        addMsg("Hiba: " + (err?.message || err), "err");
      }
    });

    // automatikus textarea n√∂vel√©s mobilon is k√©nyelmesre
    inputEl.addEventListener("input", ()=>{
      inputEl.style.height = "auto";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + "px";
    });

    // ====== Hangos besz√©l≈ë m√≥d (Web Speech API) ======
    const recState = $("#recState");
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;

    function setRecState(txt){ recState.innerHTML = `√Ållapot: <b>${txt}</b>`; }

    $("#recStart").addEventListener("click", ()=>{
      if(!SR){ alert("A b√∂ng√©sz≈ëd nem t√°mogatja a hangfelismer√©st."); return; }
      if(rec){ try{ rec.stop(); }catch(_){} }
      rec = new SR();
      rec.lang = "hu-HU";
      rec.continuous = true;
      rec.interimResults = false;

      rec.onstart = ()=> setRecState("akt√≠v");
      rec.onerror = e => { setRecState("hiba"); addMsg("Felismer√©si hiba: "+(e.error||""), "err"); };
      rec.onend = ()=> setRecState("inakt√≠v");

      rec.onresult = async (ev)=>{
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          const res = ev.results[i];
          if(res.isFinal){
            const said = res[0].transcript.trim();
            if(said){
              addMsg(said, "user");
              try{
                const r = await fetch("/.netlify/functions/chat", {
                  method:"POST",
                  headers:{ "Content-Type":"application/json" },
                  body: JSON.stringify({ message: said })
                });
                if(!r.ok){ throw new Error("HTTP "+r.status); }
                const data = await r.json();
                lastBot = (data.reply||"").toString() || "√ârtem. Miben seg√≠thetek m√©g?";
                addMsg(lastBot, "bot");
                speakHu(lastBot);
              }catch(e){
                addMsg("Hiba: "+(e?.message||e), "err");
              }
            }
          }
        }
      };

      try{ rec.start(); }catch(_){}
    });

    $("#recStop").addEventListener("click", ()=>{
      if(rec){ try{ rec.stop(); }catch(_){} }
      setRecState("inakt√≠v");
    });

    // Kezd≈ë √ºzenet
    addMsg("Szia! √çrj egy √ºzenetet, √©s v√°laszolok. üòä", "info");
  </script>
</body>
</html>

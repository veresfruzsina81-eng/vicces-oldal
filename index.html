<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HT Chat ‚Äî Kellemes besz√©lget√©st!</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2285%22>üí¨</text></svg>">
  <style>
    :root{
      --glass-bg: rgba(15,15,18,.55);
      --glass-brd: rgba(255,255,255,.14);
      --prim: #ff9a3c;
      --txt:#e7ebf3; --muted:#aab3c2;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: #0b0e13 url("bg_tamas.jpg") center/cover fixed no-repeat;
    }
    .bg-dim::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:-1;
      background:radial-gradient(1200px 800px at 75% 10%, rgba(255,154,60,.20), transparent 40%),
                 linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.78));
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{padding:28px 24px 8px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;text-shadow:0 10px 30px rgba(0,0,0,.6)}
    .brand{font-weight:800;letter-spacing:.4px;font-size:clamp(22px,3.6vw,42px)}
    .brand em{color:var(--prim);font-style:normal}
    .sub{width:100%;color:var(--muted);margin-top:6px;font-size:14px}
    .panel{border:1px solid var(--glass-brd);background:var(--glass-bg);backdrop-filter:blur(14px) saturate(120%);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:12px 14px;border-bottom:1px solid var(--glass-brd)}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:#2a2f3a;color:#d9e0ee;font-size:14px;border:1px solid rgba(255,255,255,.06)}
    .chip input{accent-color:var(--prim)}
    .tabs{margin-left:auto;display:flex;gap:6px;background:#1a1e26;padding:5px;border-radius:999px;border:1px solid var(--glass-brd)}
    .tab{padding:8px 14px;border-radius:999px;cursor:pointer;color:#cfd7e6;border:1px solid transparent}
    .tab.active{background:var(--prim);color:#111;font-weight:700}
    .chat{display:grid;grid-template-rows:1fr auto;height:min(72vh,720px)}
    .log{overflow:auto;padding:18px;scroll-behavior:smooth}
    .msg{max-width:min(720px,92%);margin:10px 0;padding:12px 14px;border-radius:14px;border:1px solid var(--glass-brd);background:rgba(255,255,255,.04)}
    .msg.user{margin-left:auto;background:rgba(255,154,60,.14);border-color:rgba(255,154,60,.35)}
    .msg.bot{margin-right:auto}
    .msg.info{margin:18px auto;text-align:center;color:#cbd3e4;background:transparent;border-color:transparent}
    .msg.err{background:rgba(255,93,93,.14);border-color:rgba(255,93,93,.4)}
    .inputRow{display:flex;gap:10px;align-items:center;padding:12px;border-top:1px solid var(--glass-brd)}
    textarea{flex:1;resize:none;min-height:44px;max-height:120px;padding:12px 14px;border-radius:14px;border:1px solid var(--glass-brd);background:#0f131a;color:var(--txt);outline:none}
    .btn{border:0;cursor:pointer;padding:12px 16px;border-radius:12px;background:var(--prim);color:#151515;font-weight:700;box-shadow:0 10px 30px rgba(255,154,60,.35)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .fab{position:fixed;right:18px;bottom:18px;width:64px;height:64px;border-radius:50%;display:grid;place-items:center;background:var(--prim);color:#111;border:0;cursor:pointer;box-shadow:0 16px 50px rgba(255,154,60,.5)}
    .fab[data-state="listening"]{animation:pulse 1.6s infinite;background:#1fe07a;box-shadow:0 16px 50px rgba(32,224,122,.55)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(32,224,122,.5)}70%{box-shadow:0 0 0 26px rgba(32,224,122,0)}100%{box-shadow:0 0 0 0 rgba(32,224,122,0)}}
    footer{text-align:center;color:#cbd3e4;font-size:12.5px;opacity:.9;padding:18px 10px;text-shadow:0 10px 30px rgba(0,0,0,.6)}
    @media (max-width:680px){.chat{height:68vh}.log{padding:12px}.msg{max-width:96%}}
  </style>
</head>
<body class="bg-dim">
  <header class="wrap">
    <div class="brand">HT <em>Chat</em> ‚Äî Kellemes besz√©lget√©st! üéâ</div>
    <div class="sub">Az oldalt l√©trehozta <strong>H.T</strong> ‚Äî egyedi fejleszt√©ssel.</div>
  </header>

  <main class="wrap panel">
    <section class="toolbar">
      <label class="chip"><input id="copyToggle" type="checkbox"> M√°sol√°s (utols√≥ v√°lasz)</label>
      <label class="chip"><input id="ttsToggle" type="checkbox"> Hang (felolvas√°s)</label>
      <div class="tabs" role="tablist" aria-label="M√≥d v√°laszt√≥">
        <button class="tab active" data-tab="chat" aria-selected="true">Chat</button>
        <button class="tab" data-tab="voice" aria-selected="false">Hangos m√≥d</button>
      </div>
    </section>

    <section class="chat" id="chatPane" role="region" aria-live="polite">
      <div id="log" class="log"></div>
      <div class="inputRow">
        <textarea id="input" placeholder="√çrj ide‚Ä¶"></textarea>
        <button id="send" class="btn">K√ºld√©s</button>
      </div>
    </section>
  </main>

  <button id="micFab" class="fab" title="Hangos m√≥d ind√≠t√°sa" aria-label="Hangos m√≥d">üé§</button>
  <footer>¬© H.T ‚Äî saj√°t hobbi fejleszt√©s. J√≥ sz√≥rakoz√°st! üéä</footer>

  <script>
    // --------- Alap UI ----------
    const logEl   = document.getElementById('log');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const copyTgl = document.getElementById('copyToggle');
    const ttsTgl  = document.getElementById('ttsToggle');
    const tabs    = document.querySelectorAll('.tab');
    const micFab  = document.getElementById('micFab');

    let lastBot = '';

    function addMsg(text, who='bot', cls=''){
      const d = document.createElement('div');
      d.className = `msg ${who} ${cls}`.trim();
      d.textContent = text;
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
      if (who==='bot'){ lastBot=text; if (ttsTgl.checked) speakHu(text); }
    }

    addMsg("Szia! √ñr√ºl√∂k, hogy itt vagy! K√©rdezz b√°tran; seg√≠tek. üòä", "info");

    // --------- Magyar felolvas√°s ----------
    let huVoice = null;
    function pickHuVoice(){
      const vs = speechSynthesis.getVoices();
      huVoice = vs.find(v => /hu|hungarian|magyar/i.test(v.lang+v.name)) || vs[0] || null;
    }
    if ('speechSynthesis' in window){
      pickHuVoice();
      window.speechSynthesis.onvoiceschanged = pickHuVoice;
    }
    function speakHu(t){
      try{
        const u = new SpeechSynthesisUtterance(t);
        if (huVoice) u.voice = huVoice;
        u.lang = huVoice?.lang || 'hu-HU';
        u.rate = 1; u.pitch = 1;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch{}
    }

    // --------- D√°tum/Id≈ë seg√©dek ----------
    const WEEKDAYS = ['vas√°rnap','h√©tf≈ë','kedd','szerda','cs√ºt√∂rt√∂k','p√©ntek','szombat'];
    const WEEKDAY_INDEX = { 'vas√°rnap':0, 'hetfo':1,'h√©tf≈ë':1,'kedd':2,'szerda':3,'cs√ºt√∂rtok':4,'cs√ºt√∂rt√∂k':4,'pentek':5,'p√©ntek':5,'szombat':6 };

    function norm(s){ return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }

    function fmtDateHu(dt){
      return new Intl.DateTimeFormat('hu-HU',{
        year:'numeric', month:'long', day:'numeric', weekday:'long'
      }).format(dt);
    }
    function fmtTimeHu(dt){
      return new Intl.DateTimeFormat('hu-HU',{hour:'2-digit',minute:'2-digit'}).format(dt);
    }
    function addDays(base, n){
      const d = new Date(base);
      d.setDate(d.getDate()+n);
      return d;
    }
    function nextWeekday(base, targetIdx){
      const d0 = new Date(base);
      const todayIdx = d0.getDay();
      let delta = (targetIdx - todayIdx + 7) % 7;
      if (delta===0) delta = 7; // k√∂vetkez≈ë ugyanaz = +7
      return addDays(d0, delta);
    }

    // --------- Helyi (API n√©lk√ºli) v√°laszok d√°tum/id≈ëre ----------
    function localDateAnswer(raw){
      const t = norm(raw).trim();
      if (!t) return null;

      // teljes d√°tum + id≈ë
      if (t.includes('datum es ido') || t.includes('pontos datum es ido')){
        const now = new Date();
        return `Ma ${fmtDateHu(now)} van, az id≈ë pedig ${fmtTimeHu(now)}.`;
      }

      // csak id≈ë
      if (t.includes('mennyi az ido') || t.includes('hany ora van') || t.includes('pontos ido') || /^ido\??$/.test(t)){
        return `Most az id≈ë: ${fmtTimeHu(new Date())}.`;
      }

      // csak d√°tum / mai nap
      if (t.includes('milyen datum van ma') || t.includes('mai datum') || t.includes('hanyadika van') || t.includes('milyen nap van ma') || /^datum\??$/.test(t)){
        return `Ma ${fmtDateHu(new Date())} van.`;
      }

      // relat√≠v napok: tegnap/holnap/holnaput√°n
      if (t.includes('tegnap')){
        const d = addDays(new Date(), -1);
        return `Tegnap ${fmtDateHu(d)} volt.`;
      }
      if (t.includes('holnaputan') || t.includes('holnap utan')){
        const d = addDays(new Date(), 2);
        return `Holnaput√°n ${fmtDateHu(d)} lesz.`;
      }
      if (t.includes('holnap')){
        const d = addDays(new Date(), 1);
        return `Holnap ${fmtDateHu(d)} lesz.`;
      }

      // X nap m√∫lva / X nap ut√°n
      let m;
      m = t.match(/(\d+)\s*nap\s*(mulva|utan)/);
      if (m){
        const n = parseInt(m[1],10);
        const d = addDays(new Date(), n);
        return `${n} nap m√∫lva ${fmtDateHu(d)} lesz.`;
      }
      // X napja / X nappal ezel≈ëtt
      m = t.match(/(\d+)\s*nap(pal)?\s*(ezelott|korabban|ota|ja)/);
      if (m){
        const n = parseInt(m[1],10);
        const d = addDays(new Date(), -n);
        return `${n} napja ${fmtDateHu(d)} volt.`;
      }

      // k√∂vetkez≈ë h√©tf≈ë/kedd/‚Ä¶ (k√∂vetkezo <nap>)
      m = t.match(/kovetkez[o√∂]\s+([a-z√°√©√≠√≥√∂≈ë√∫√º≈±]+)\b/);
      if (m){
        const wdName = m[1];
        const idx = WEEKDAY_INDEX[ norm(wdName) ];
        if (typeof idx === 'number'){
          const d = nextWeekday(new Date(), idx);
          return `A k√∂vetkez≈ë ${WEEKDAYS[idx]} ${fmtDateHu(d)} lesz.`;
        }
      }

      // j√∂v≈ë h√©t <nap> ‚Äî szint√©n k√∂vetkez≈ë el≈ëfordul√°sk√©nt kezelj√ºk
      m = t.match(/jov[o≈ë]\s+h[e√©]t\s+([a-z√°√©√≠√≥√∂≈ë√∫√º≈±]+)\b/);
      if (m){
        const wdName = m[1];
        const idx = WEEKDAY_INDEX[ norm(wdName) ];
        if (typeof idx === 'number'){
          const d = nextWeekday(new Date(), idx);
          return `J√∂v≈ë h√©ten, ${WEEKDAYS[idx]} napj√°n: ${fmtDateHu(d)}.`;
        }
      }

      return null; // nem helyi d√°tum/ido k√©rd√©s
    }

    // --------- Speci√°lis fix v√°laszok (k√©sz√≠t≈ë/modell) ----------
    function fixedAnswer(raw){
      const t = raw.toLowerCase();
      const owner = ['ki k√©sz√≠tette','ki hozta l√©tre','ki a tulaj','ki a tulajdonos','k√©sz√≠t≈ëje','tulajdonosa','k√©sz√≠tette ezt az oldalt'];
      if (owner.some(k => t.includes(k))){
        return "Az oldalt Horv√°th Tam√°s (Szabolcsb√°ka) k√©sz√≠tette hobbi fejleszt√©sk√©nt. üòä";
      }
      if ((t.includes('horv√°th tam√°s') || t.includes('horvath tamas')) && (t.includes('ki') || t.includes('mes√©lj') || t.includes('mutasd'))){
        return "Horv√°th Tam√°s lelkes hobbiprogramoz√≥ Szabolcsb√°k√°r√≥l. Webes projektekkel √©s mesters√©ges intelligenci√°val k√≠s√©rletezik; folyamatosan fejleszti a tud√°s√°t.";
      }
      if (t.includes('milyen modell') || t.includes('ki vagy te') || t.includes('milyen chat')){
        return "√ân Tam√°s modellje vagyok. ≈ê k√©sz√≠tett √©s fejlesztett, hogy seg√≠tsek neked b√°rmiben. üôÇ";
      }
      return null;
    }

    // --------- K√ºld√©s logika ----------
    async function sendNow(){
      const text = inputEl.value.trim();
      if(!text) return;
      inputEl.value=''; addMsg(text,'user');

      // 1) Helyi d√°tum/id≈ë
      const local = localDateAnswer(text);
      if (local){ addMsg(local,'bot'); return; }

      // 2) Fix inf√≥k
      const fx = fixedAnswer(text);
      if (fx){ addMsg(fx,'bot'); return; }

      // 3) OpenAI backend
      addMsg("‚Ä¶","bot","info");
      try{
        const r = await fetch("/.netlify/functions/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ message: text })
        });
        const info = document.querySelector('.msg.info:last-of-type'); if(info) info.remove();
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const reply = (data.reply||"").toString().trim() || "Rendben. Miben seg√≠thetek m√©g?";
        addMsg(reply,'bot');
        if (copyTgl.checked){ try{ await navigator.clipboard.writeText(reply); }catch{} }
      }catch(e){
        const info = document.querySelector('.msg.info:last-of-type'); if(info) info.remove();
        addMsg("Hiba: "+(e?.message||'ismeretlen hiba'),'bot','err');
      }
    }

    sendBtn.addEventListener('click', sendNow);
    inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendNow(); } });

    // --------- Tabok ----------
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const isVoice = t.dataset.tab==='voice';
        document.querySelector('.inputRow').style.display = isVoice ? 'none' : 'flex';
        micFab.style.display = isVoice ? 'grid' : 'none';
        addMsg(isVoice
          ? "Koppints a jobb als√≥ üé§ gombra. Egyszer elind√≠tod ‚Üí folyamatosan hallgat √©s v√°laszol (am√≠g le nem √°ll√≠tod)."
          : "√çrj nyugodtan b√°rmit. üôÇ","info");
      });
    });

    // --------- Hangos m√≥d (Web Speech API) ----------
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec=null, listening=false;
    if(SR){
      rec = new SR();
      rec.lang = 'hu-HU'; rec.continuous = true; rec.interimResults = false;
      rec.onresult = async (ev)=>{
        const last = ev.results[ev.results.length-1];
        if(last?.isFinal){
          const said = last[0].transcript.trim();
          if(!said) return;
          addMsg(said,'user'); inputEl.value = said; await sendNow();
        }
      };
      rec.onerror = e => { addMsg("Felismer√©si hiba: "+(e.error||'ismeretlen'),'bot','err'); stopRec(); };
      rec.onend   = ()=>{ if(listening){ try{ rec.start(); }catch{} } };
    }else{
      micFab.style.display='none';
    }
    function startRec(){ if(!rec) return; try{ rec.start(); listening=true; micFab.dataset.state='listening'; }catch{} }
    function stopRec(){ if(!rec) return; try{ rec.stop(); }catch{} listening=false; micFab.removeAttribute('data-state'); }
    micFab.addEventListener('click', ()=> listening ? stopRec() : startRec());
    document.addEventListener('click', ()=>{}, {once:true}); // iOS TTS enged√©ly
  </script>
<div id="robot-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;"></div>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>
<script>
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById("robot-container").appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(0, 1, 1).normalize();
  scene.add(light);

  const loader = new THREE.GLTFLoader();
  loader.load('robot.glb', (gltf) => {
    scene.add(gltf.scene);
    gltf.scene.position.set(0, -1, 0);
    gltf.scene.scale.set(2, 2, 2);
    animate();
  });

  camera.position.z = 5;
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>
<div id="robot-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;"></div>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>
<script>
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById("robot-container").appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(0, 1, 1).normalize();
  scene.add(light);

  const loader = new THREE.GLTFLoader();
  loader.load('robot.glb', (gltf) => {
    scene.add(gltf.scene);
    gltf.scene.position.set(0, -1, 0);
    gltf.scene.scale.set(2, 2, 2);
    animate();
  });

  camera.position.z = 5;
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>
</body>
</html>

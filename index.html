<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tam√°s AI ‚Äî Kellemes besz√©lget√©st!</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%23222'/%3E%3Ctext x='50' y='62' font-size='56' text-anchor='middle' fill='%23ffa32a' font-family='Segoe UI, Roboto, Arial'%3ET%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#0e0f12;
      --bg2:#15171c;
      --glass:rgba(255,255,255,0.05);
      --line:rgba(255,255,255,0.12);
      --text:#e7e7ea;
      --muted:#b9bdc7;
      --brand:#ffa32a;
      --accent:#7bdcff;
      --ok:#21c07a;
      --warn:#ffb84d;
      --err:#ff5c6c;
      --bubble:#20232a;
      --bubble-me:#2b1e12;
      --bubble-info:#1b2130;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:radial-gradient(1200px 1200px at 10% 10%, #1b1f27 0%, #101217 40%, #0b0c10 100%), var(--bg);
      font-family: "Segoe UI", Roboto, Arial, sans-serif; overflow:hidden;
    }
    .app{
      display:grid; grid-template-rows:auto 1fr auto; height:100%;
    }
    header{
      display:flex; align-items:center; gap:14px; padding:12px 18px; border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      backdrop-filter:saturate(140%) blur(6px);
    }
    .logo{
      width:36px; height:36px; border-radius:50%; background:#222; display:grid; place-items:center; 
      box-shadow:0 0 0 2px #333 inset, 0 8px 24px rgba(0,0,0,.35);
      font-weight:700; color:var(--brand);
    }
    .title{font-weight:800; letter-spacing:.2px}
    .grow{flex:1}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--glass); border:1px solid var(--line); font-size:13px; color:var(--muted)}
    .chip input{accent-color:var(--brand)}
    .layout{
      display:grid; grid-template-columns: minmax(280px, 720px) minmax(260px, 1fr); gap:16px; height:100%; padding:16px;
    }
    /* Chat card */
    .card{
      height:100%; border:1px solid var(--line); border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow:0 10px 30px rgba(0,0,0,.45); display:flex; flex-direction:column; overflow:hidden;
    }
    .cardhd{display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(255,255,255,0.02)}
    .badge{font-size:12px; padding:5px 9px; border-radius:999px; background:var(--bubble-info); color:#cfe3ff; border:1px solid #223048}
    .chat{
      flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth;
    }
    .msg{
      max-width:82%; padding:12px 14px; border-radius:14px; border:1px solid var(--line);
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      line-height:1.45; font-size:15px;
    }
    .bot{ align-self:flex-start; background:var(--bubble); }
    .me{ align-self:flex-end; background:var(--bubble-me); border-color:rgba(255,163,42,.35)}
    .info{ align-self:center; background:var(--bubble-info); color:#cfe3ff}
    .time{font-size:12px; color:var(--muted); margin-top:6px}
    .inputbar{
      display:flex; gap:10px; padding:12px; border-top:1px solid var(--line); background:rgba(255,255,255,0.02)
    }
    textarea{
      flex:1; resize:none; min-height:44px; max-height:120px; padding:12px 14px; border-radius:12px;
      border:1px solid var(--line); background:#171a20; color:var(--text); outline:none;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:0 16px; min-width:86px; height:44px; border-radius:12px; border:1px solid #4a331a;
      background:linear-gradient(180deg,#ffb761,#ff9a1d); color:#1a1208; font-weight:700; cursor:pointer;
      box-shadow:0 8px 18px rgba(255,163,42,.25);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    /* Voice drawer */
    .voice{
      height:100%; border:1px solid var(--line); border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow:0 10px 30px rgba(0,0,0,.45); overflow:hidden; display:flex; flex-direction:column;
    }
    .voice .top{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.02)}
    .status{font-size:13px; color:var(--muted)}
    .micwrap{display:grid; place-items:center; padding:22px}
    .micbtn{
      width:84px; height:84px; border-radius:50%; border:2px solid #2a2d36;
      background: radial-gradient(circle at 30% 30%, #ffcd85, #ff8e1a);
      box-shadow:0 12px 30px rgba(255,163,42,.3), inset 0 0 0 6px rgba(0,0,0,.25);
      cursor:pointer;
    }
    .micbtn.stop{
      background: radial-gradient(circle at 30% 30%, #ff8aa0, #ff485f);
      box-shadow:0 12px 30px rgba(255,92,108,.35), inset 0 0 0 6px rgba(0,0,0,.25);
    }
    .switch{
      display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:999px; background:var(--glass); border:1px solid var(--line); font-size:13px; color:var(--muted)
    }
    .switch input{accent-color:var(--brand)}
    /* 3D panel */
    .stage{
      position:relative; flex:1; min-height:280px; background:radial-gradient(600px 300px at 60% 10%, #242833, #14171c);
    }
    canvas{display:block; width:100%; height:100%}
    .stage .overlay{
      position:absolute; inset:auto 10px 10px 10px; display:flex; justify-content:space-between; gap:10px; pointer-events:none;
      font-size:12px; color:var(--muted)
    }
    .stage .overlay .pill{pointer-events:auto; padding:6px 10px; background:var(--glass); border:1px solid var(--line); border-radius:999px}
    footer{
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; border-top:1px solid var(--line); background:rgba(255,255,255,0.02); color:var(--muted); font-size:13px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr; grid-template-rows: 1fr 320px;}
      .stage{min-height:260px}
      body{overflow:auto}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">T</div>
      <div class="title">Tam√°s AI</div>
      <div class="grow"></div>
      <label class="chip"><input type="checkbox" id="copyLast"> M√°sol√°s (utols√≥ v√°lasz)</label>
      <label class="chip"><input type="checkbox" id="tts" checked> Hang (felolvas√°s)</label>
    </header>

    <div class="layout">
      <!-- CHAT -->
      <section class="card" aria-label="Besz√©lget√©s">
        <div class="cardhd">
          <span class="badge" id="todayBadge">D√°tum bet√∂lt√©se‚Ä¶</span>
          <span class="badge" id="timeBadge">Id≈ë bet√∂lt√©se‚Ä¶</span>
          <span class="badge" id="modelBadge">Modell: Tam√°s</span>
          <span class="grow"></span>
          <span class="badge" id="apiStatus">API: k√©sz</span>
        </div>
        <div id="chat" class="chat" aria-live="polite"></div>
        <div class="inputbar">
          <textarea id="ta" placeholder="√çrj ide‚Ä¶"></textarea>
          <button id="send" class="btn">K√ºld√©s</button>
        </div>
      </section>

      <!-- VOICE + 3D -->
      <section class="voice" aria-label="Hangos m√≥d">
        <div class="top">
          <div style="display:flex; gap:10px; align-items:center">
            <strong>Hangos m√≥d</strong>
            <span class="status" id="recStatus">Inakt√≠v</span>
          </div>
          <div style="display:flex; gap:10px; align-items:center">
            <label class="switch"><input type="checkbox" id="continuous" checked> Folyamatos</label>
            <label class="switch"><input type="checkbox" id="voiceOnly"> Ne jelenjen meg a chatben</label>
          </div>
        </div>
        <div class="micwrap">
          <button id="mic" class="micbtn" title="Ind√≠t√°s / Le√°ll√≠t√°s"></button>
        </div>
        <div class="stage" id="stage">
          <div class="overlay">
            <span class="pill">3D robot</span>
            <span class="pill" id="stageStatus">Bet√∂lt√©s‚Ä¶</span>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <div>¬© H.T ‚Äî saj√°t hobbi fejleszt√©s. J√≥ sz√≥rakoz√°st! üéâ</div>
      <div id="footerClock">‚Äî</div>
    </footer>
  </div>

  <!-- Three.js + GLTFLoader (CDN) -->
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.157.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
  // ======= UTIL =======
  const $ = (sel, root=document)=>root.querySelector(sel);
  const chatEl = $('#chat');
  const ta = $('#ta'); const sendBtn = $('#send');
  const copyLast = $('#copyLast'); const tts = $('#tts');
  const apiStatus = $('#apiStatus');
  const todayBadge = $('#todayBadge'); const timeBadge = $('#timeBadge');
  const footerClock = $('#footerClock');
  let lastBot = '';

  function nowHu(){
    const d = new Date();
    const date = d.toLocaleDateString('hu-HU', { year:'numeric', month:'long', day:'numeric', weekday:'long' });
    const time = d.toLocaleTimeString('hu-HU', { hour:'2-digit', minute:'2-digit' });
    return {date, time, d};
  }
  function addMsg(text, who='bot', kind=''){
    const m = document.createElement('div');
    m.className = 'msg ' + (who==='me' ? 'me' : (who==='info' ? 'info' : 'bot'));
    m.innerText = text;
    chatEl.appendChild(m);
    chatEl.scrollTop = chatEl.scrollHeight;
    return m;
  }
  function speakHu(text){
    if(!tts.checked || !('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    const chooseVoice = ()=>{
      const vs = speechSynthesis.getVoices();
      const hu = vs.find(v=>/hu/i.test(v.lang)) || vs.find(v=>/Google magyar/i.test(v.name)) || vs[0];
      if(hu) utter.voice = hu;
      utter.rate = 1; utter.pitch = 1; utter.lang = (hu && hu.lang) || 'hu-HU';
      speechSynthesis.cancel(); // stop previous
      speechSynthesis.speak(utter);
    };
    const ready = speechSynthesis.getVoices();
    if(!ready || ready.length===0){
      speechSynthesis.onvoiceschanged = chooseVoice;
    }else chooseVoice();
  }

  // ======= FIX & SMART ANSWERS =======
  function dayName(d){ return d.toLocaleDateString('hu-HU', { weekday:'long' }); }
  function dateStr(d){ return d.toLocaleDateString('hu-HU', { year:'numeric', month:'long', day:'numeric' }); }
  function plusDays(n){ const d=new Date(); d.setDate(d.getDate()+n); return d; }

  function timeAnswers(textRaw){
    const text = textRaw.toLowerCase().trim();
    const {date, time} = nowHu();

    // ma/holnap/holnaput√°n
    if (/(mennyi az id≈ë|h√°ny √≥ra|h√°ny √≥ra van)/.test(text)) return `Most ${time} van.`;
    if (/(mi a mai d√°tum|milyen d√°tum van ma|milyen nap van ma)/.test(text)) return `Ma ${date}.`;
    if (/holnap( mi| milyen)? (a )?d√°tum/.test(text) || /milyen d√°tum lesz holnap/.test(text)){
      const d = plusDays(1); return `Holnap ${dateStr(d)} (${dayName(d)}).`;
    }
    if (/holnaput√°n/.test(text)){
      const d = plusDays(2); return `Holnaput√°n ${dateStr(d)} (${dayName(d)}).`;
    }
    const napMulva = text.match(/(\d+)\s*nap(?:\s*m√∫lva|\s*mulva)/);
    if(napMulva){
      const n = parseInt(napMulva[1],10); const d=plusDays(n);
      return `${n} nap m√∫lva ${dateStr(d)} (${dayName(d)}).`;
    }
    return null;
  }

  function fixedAnswer(textRaw){
    const text = textRaw.toLowerCase().trim();

    // 1) id≈ëk, d√°tumok
    const t = timeAnswers(textRaw);
    if(t) return t;

    // 2) modell
    if (/(milyen modell|milyen ai|ki vagy te|ki besz√©l)/.test(text)){
      return "√ân Tam√°s modellje vagyok. Horv√°th Tam√°s k√©sz√≠tett √©s fejlesztett ‚Äî az√©rt, hogy seg√≠tsek neked b√°rmiben. üôÇ";
    }

    // 3) k√©sz√≠t≈ë
    if (/(ki k√©sz√≠tette|ki hozta l√©tre|ki csin√°lta).*(oldal|weboldal)/.test(text)){
      return "Az oldalt Horv√°th Tam√°s (Szabolcsb√°ka) k√©sz√≠tette hobbi-fejleszt√©sk√©nt. üåü";
    }
    if (/(mes√©lj).*(horv√°th tam√°s|szabolcsb√°ka)/.test(text)){
      return "Horv√°th Tam√°s lelkes hobbiprogramoz√≥: webes projektekkel √©s mesters√©ges intelligenci√°val k√≠s√©rletezik, √∫j √∂tleteket pr√≥b√°l ki √©s folyamatosan fejleszti a tud√°s√°t. üí°";
    }

    // 4) m√°s sablon
    if (/k√∂sz√∂n|szia|hell√≥|hello|√ºdv/.test(text)){
      return "Szia! √ñr√ºl√∂k, hogy itt vagy. K√©rdezz b√°tran ‚Äî seg√≠tek. üôÇ";
    }

    return null;
  }

  // ======= CHAT FLOW =======
  async function ask(text){
    if(!text) return;
    addMsg(text, 'me');
    ta.value = '';

    // helyi okos v√°lasz
    const local = fixedAnswer(text);
    if(local){ lastBot = local; addMsg(local, 'bot'); speakHu(local); return; }

    // inform√°ci√≥s cs√≠k
    const info = addMsg("‚Ä¶", "info");
    try{
      const r = await fetch('/.netlify/functions/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ message: text })
      });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      info.remove();
      lastBot = String(data.reply || "√ârtem. Miben seg√≠thetek m√©g?");
      addMsg(lastBot, 'bot'); speakHu(lastBot);
    }catch(e){
      info.remove();
      addMsg(`Hiba: ${e.message || e}`, 'info');
    }
  }

  // UI k√∂t√©s
  sendBtn.addEventListener('click', ()=>ask(ta.value.trim()));
  ta.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(ta.value.trim()); }
  });
  copyLast.addEventListener('change', ()=>{
    if(copyLast.checked && lastBot) navigator.clipboard.writeText(lastBot).catch(()=>{});
  });

  // Kezd≈ë √ºzenet
  addMsg("Szia! √ñr√ºl√∂k, hogy itt vagy! K√©rdezz b√°tran; seg√≠tek. üôÇ", 'bot');

  // Fejl√©cek: d√°tum/√≥ra
  function refreshClocks(){
    const {date,time} = nowHu();
    todayBadge.textContent = date;
    timeBadge.textContent = time;
    footerClock.textContent = `${date} ‚Äî ${time}`;
  }
  refreshClocks(); setInterval(refreshClocks, 10_000);

  // ======= VOICE (Web Speech API) =======
  const recStatus = $('#recStatus'); const micBtn = $('#mic');
  const continuous = $('#continuous'); const voiceOnly = $('#voiceOnly');
  let rec = null; let listening = false; let interim = '';

  function setRecState(state){
    recStatus.textContent = state;
    if(state==='Hallgatok‚Ä¶'){ micBtn.classList.add('stop'); }
    else{ micBtn.classList.remove('stop'); }
  }

  function setupRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ setRecState('Nem t√°mogatott ezen az eszk√∂z√∂n üòï'); return null; }
    const r = new SR();
    r.lang = 'hu-HU';
    r.interimResults = true;
    r.continuous = true; // mi is kezelj√ºk √∫jraind√≠t√°ssal
    r.maxAlternatives = 1;

    r.onstart = ()=> setRecState('Hallgatok‚Ä¶');
    r.onerror = (e)=> setRecState('Hiba: ' + (e.error || 'ismeretlen'));
    r.onend = ()=>{
      setRecState('Le√°ll√≠tva');
      if(listening && continuous.checked){
        // iOS/Android miatt kis k√©sleltet√©ssel √∫jraind√≠t√°s
        setTimeout(()=>{ try{ r.start(); }catch{} }, 300);
      }
    };
    r.onresult = (ev)=>{
      let finalText = '';
      for(let i=ev.resultIndex; i<ev.results.length; i++){
        const res = ev.results[i];
        if(res.isFinal) finalText += res[0].transcript;
        else interim = res[0].transcript;
      }
      if(finalText){
        const text = finalText.trim();
        if(!voiceOnly.checked) addMsg(text, 'me');
        // helyi -> backend
        const local = fixedAnswer(text);
        const respond = async (t)=>{
          lastBot = t; if(!voiceOnly.checked) addMsg(t,'bot'); speakHu(t);
        }
        if(local) respond(local);
        else fetch('/.netlify/functions/chat',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:text})})
          .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
          .then(d=>respond(String(d.reply||'√ârtem. Miben seg√≠thetek m√©g?')))
          .catch(e=>{ if(!voiceOnly.checked) addMsg('Hiba: '+e.message,'info'); });
      }
    };
    return r;
  }

  micBtn.addEventListener('click', ()=>{
    if(!rec) rec = setupRecognition();
    if(!rec) return;
    if(!listening){ try{ rec.start(); listening = true; }catch(e){} }
    else{ try{ rec.stop(); }catch(e){} listening = false; }
  });

  // ======= 3D ROBOT (Three.js) =======
  const stage = $('#stage'); const stageStatus = $('#stageStatus');
  let renderer, scene, camera;

  function init3D(){
    const w = stage.clientWidth, h = stage.clientHeight;
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(w, h); renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
    stage.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(35, w/h, 0.1, 100);
    camera.position.set(0, 1.2, 2.6);

    // f√©nyek
    const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 0.9); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.9); dir.position.set(2,2,2); scene.add(dir);

    // talaj gy≈±r≈±
    const geo = new THREE.TorusGeometry(1.2, 0.02, 16, 60);
    const mat = new THREE.MeshStandardMaterial({ color:0x293140, metalness:.2, roughness:.6 });
    const ring = new THREE.Mesh(geo, mat); ring.rotation.x = -Math.PI/2; ring.position.y = -0.6; scene.add(ring);

    // robot bet√∂lt√©s
    stageStatus.textContent = 'Robot bet√∂lt√©se‚Ä¶';
    const loader = new THREE.GLTFLoader();
    loader.load('CesiumMan.glb', (gltf)=>{
      const model = gltf.scene;
      model.scale.set(1.8,1.8,1.8);
      model.position.set(0,-0.6,0);
      scene.add(model);
      stageStatus.textContent = 'Robot k√©sz ‚úÖ';
      // kis mozg√°s
      function animate(){
        requestAnimationFrame(animate);
        model.rotation.y += 0.006;
        renderer.render(scene, camera);
      }
      animate();
      // kedves k√∂sz√∂n√©s TTS-ben is
      setTimeout(()=> speakHu('Szia! Itt vagyok. K√©rdezz b√°tran!'), 600);
    }, undefined, (err)=>{
      console.error('GLB hiba:', err); stageStatus.textContent = 'Robot bet√∂lt√©si hiba';
    });

    window.addEventListener('resize', ()=>{
      const w = stage.clientWidth, h = stage.clientHeight;
      renderer.setSize(w,h);
      camera.aspect = w/h; camera.updateProjectionMatrix();
    });
  }
  init3D();

  // ======= INFO =======
  apiStatus.textContent = 'API: k√©sz';
  </script>
</body>
</html>
